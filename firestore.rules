rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 辅助函数：检查今天是否还可以上传
    function canUploadToday() {
      // 直接使用内联日期计算，避免字符串拼接问题
      let year = request.time.year();
      let month = request.time.month();
      let day = request.time.day();

      // 构造日期字符串 YYYY-MM-DD
      let dateStr = string(year) + '-' +
                    (month < 10 ? '0' : '') + string(month) + '-' +
                    (day < 10 ? '0' : '') + string(day);

      // 获取计数器文档的引用
      let counterPath = /databases/$(database)/documents/upload-counters/$(dateStr);

      // 如果计数器不存在，允许上传
      // 如果计数器存在且 count < 50，允许上传
      return !exists(counterPath) || get(counterPath).data.count < 50;
    }

    // 游戏日志元数据 - 允许匿名创建，但检查每日上传限制
    match /game-logs/{logId} {
      // 创建：检查必需字段 + 每日上传限制
      // 注意：uploadedAt 使用 serverTimestamp()，在 Rules 中会被自动处理
      allow create: if request.resource.data.keys().hasAll(['league', 'fileName', 'storagePath'])
                    && request.resource.data.league is string
                    && request.resource.data.fileName is string
                    && request.resource.data.storagePath is string
                    && canUploadToday();  // 服务端强制限制

      // 所有人可以读取
      allow read: if true;

      // 不允许普通用户更新/删除（只有 Cloud Functions）
      allow update, delete: if false;
    }

    // 上传计数器 - 记录每天的上传数量
    match /upload-counters/{date} {
      // 所有人可以读取计数器
      allow read: if true;

      // 只有 Cloud Functions 可以写入（通过 Admin SDK）
      allow write: if false;
    }

    // 处理状态日志 - 只有 Cloud Functions 可以写入
    match /processing-logs/{logId} {
      allow read: if true;
      allow write: if false;
    }

    // 默认拒绝所有其他访问
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
