<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÆ°ÂàÜÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .language-switcher a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f1ff;
            color: #4b50c5;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            border: 1px solid rgba(102, 126, 234, 0.4);
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .language-switcher a:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .language-switcher a.active {
            background: #667eea;
            color: white;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        input, select, button {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .top-right-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .language-switcher,
        .rule-switch {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .rule-btn-compact {
            padding: 8px 16px;
            background: white;
            border: 2px solid #ddd;
            color: #666;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rule-btn-compact:hover:not(:disabled) {
            background: #f0f0f0;
            border-color: #667eea;
            color: #667eea;
        }

        .rule-btn-compact.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .rule-btn-compact:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scores-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .player-score {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 3px solid #667eea;
            transition: all 0.3s;
        }

        .player-score.dealer {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-color: #f39c12;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .player-score input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #667eea;
            color: #667eea;
            font-weight: bold;
            font-size: 1em;
            text-align: center;
            padding: 5px;
            width: 100%;
            transition: all 0.3s;
        }

        .player-score.dealer input {
            border-bottom-color: #f39c12;
            color: #d35400;
        }

        .player-score input:focus {
            outline: none;
            border-bottom-color: #5568d3;
        }

        .player-score input::placeholder {
            color: #999;
        }

        .player-score .score {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }

        .record-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .history {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item .details {
            flex: 1;
        }

        .history-item button {
            background: #dc3545;
            padding: 5px 15px;
            font-size: 14px;
        }

        .history-item button:hover {
            background: #c82333;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #dc3545;
            font-weight: 600;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            font-weight: 600;
            padding: 10px;
            background: #d4edda;
            border-radius: 5px;
            margin-top: 10px;
        }

        .dealer-badge {
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }

        .yaku-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
        }

        .yaku-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            padding: 0;
            font-size: 1.1em;
        }

        .yaku-tag button:hover {
            color: #dc3545;
            transform: none;
            box-shadow: none;
        }

        .yaku-selector {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .yaku-selector input {
            flex: 1;
        }

        .yaku-selector button {
            padding: 10px 20px;
            white-space: nowrap;
        }

        .selected-yaku-list {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <div class="top-right-panel">
        <div class="language-switcher">
            <a href="game_tracker.html?lang=zh" data-lang="zh">üá®üá≥ ‰∏≠Êñá</a>
            <a href="game_tracker.html?lang=en" data-lang="en">üá∫üá∏ English</a>
        </div>
        <div class="rule-switch">
            <button class="rule-btn-compact active" data-rule="mleague" title="M-League (25000ÁÇπ)">M-League</button>
            <button class="rule-btn-compact" data-rule="wrc" title="WRC (30000ÁÇπ)">WRC</button>
        </div>
    </div>

    <div class="container">
        <h1 data-i18n="title_main">üÄÑ È∫ªÂ∞ÜÁÇπÊï∞ËÆ°ÁÆóÂô®</h1>

        <!-- ÁÇπÊï∞ÊòæÁ§∫ -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 data-i18n="section_current_scores" style="margin: 0;">ÂΩìÂâçÁÇπÊï∞</h2>
                <div id="game-info-compact" style="font-size: 14px; color: #667eea; font-weight: 600;">
                    <span id="current-round">‰∏ú1Â±Ä</span>
                    <span id="honba-display" style="margin-left: 15px;">0Êú¨Âú∫</span>
                    <span style="margin-left: 15px;" data-i18n="label_riichi_sticks_prefix">‰æõÊâò</span>: <span id="riichi-sticks">0</span><span data-i18n="label_riichi_sticks_suffix">Êú¨</span>
                </div>
            </div>
            <div class="scores-display" id="scores-display"></div>
            <div id="game-end-notice" style="display: none; margin-top: 20px; padding: 20px; background: #ffc107; border-radius: 10px; text-align: center;">
                <h3 data-i18n="game_end_title" style="color: #333; margin-bottom: 15px; font-size: 1.5em;">üèÜ ÂØπÂ±ÄÁªìÊùü üèÜ</h3>
                <div id="final-results"></div>
            </div>
        </div>

        <!-- ËÆ∞ÂΩïÂíåÁâå -->
        <div class="section">
            <h2 data-i18n="section_record_win">ËÆ∞ÂΩïÂíåÁâå</h2>
            <div class="record-form">
                <div class="input-group">
                    <label data-i18n="label_winner">ÂíåÁâåËÄÖ</label>
                    <select id="winner"></select>
                </div>
                <div class="input-group">
                    <label data-i18n="label_loser">ÁÇπÁÇÆËÄÖÔºàËá™Êë∏ÈÄâÊã©"Ëá™Êë∏"Ôºâ</label>
                    <select id="loser">
                        <option value="tsumo" data-i18n-option="option_tsumo">Ëá™Êë∏</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;" data-i18n="label_choose_yaku">ÈÄâÊã©ÂΩπÁßç</label>
                <div class="yaku-selector">
                    <div class="input-group" style="flex: 1; margin: 0;">
                        <input type="text" id="yaku-search" list="yaku-datalist" placeholder="ËæìÂÖ•ÊêúÁ¥¢Êàñ‰ªéÂàóË°®ÈÄâÊã©..." data-i18n-placeholder="placeholder_yaku_search">
                        <datalist id="yaku-datalist"></datalist>
                    </div>
                    <button onclick="addYaku()" style="background: #28a745;" data-i18n="button_add_yaku">Ê∑ªÂä†</button>
                </div>
                <div class="selected-yaku-list" id="selected-yaku-list">
                    <div style="color: #999;" data-i18n="selected_yaku_placeholder">ËØ∑ÈÄâÊã©ÂΩπÁßç...</div>
                </div>
            </div>
            <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div class="input-group">
                    <label data-i18n="label_dora">ÂÆùÁâå</label>
                    <input type="number" id="dora-count" value="0" min="0" max="20" style="text-align: center;">
                </div>
                <div class="input-group">
                    <label data-i18n="label_aka_dora">Ëµ§ÂÆùÁâå</label>
                    <input type="number" id="aka-dora-count" value="0" min="0" max="3" style="text-align: center;">
                </div>
                <div class="input-group">
                    <label data-i18n="label_ura_dora">ÈáåÂÆùÁâå</label>
                    <input type="number" id="ura-dora-count" value="0" min="0" max="20" style="text-align: center;">
                </div>
            </div>
            <div class="record-form" style="margin-top: 15px;">
                <div class="input-group">
                    <label data-i18n="label_fu">Á¨¶Êï∞</label>
                    <select id="fu">
                        <option value="20" data-i18n-option="fu_value">20Á¨¶</option>
                        <option value="25" data-i18n-option="fu_value">25Á¨¶Ôºà‰∏ÉÂØπÂ≠êÔºâ</option>
                        <option value="30" data-i18n-option="fu_value" selected>30Á¨¶</option>
                        <option value="40" data-i18n-option="fu_value">40Á¨¶</option>
                        <option value="50" data-i18n-option="fu_value">50Á¨¶</option>
                        <option value="60" data-i18n-option="fu_value">60Á¨¶</option>
                        <option value="70" data-i18n-option="fu_value">70Á¨¶</option>
                        <option value="80" data-i18n-option="fu_value">80Á¨¶</option>
                        <option value="90" data-i18n-option="fu_value">90Á¨¶</option>
                        <option value="100" data-i18n-option="fu_value">100Á¨¶</option>
                        <option value="110" data-i18n-option="fu_value">110Á¨¶</option>
                    </select>
                </div>
                <div class="input-group">
                    <div class="checkbox-group" style="align-items: center; height: 100%; padding-top: 25px;">
                        <input type="checkbox" id="menzen" checked>
                        <label for="menzen" data-i18n="label_menzen">Èó®Ê∏Ö</label>
                    </div>
                </div>
            </div>
            <div id="yaku-preview" style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px; display: none;">
                <div style="font-weight: 600; margin-bottom: 10px;" data-i18n="preview_title">ËÆ°ÁÆóÈ¢ÑËßàÔºö</div>
                <div id="yaku-recognized" style="color: #28a745; margin-bottom: 5px;"></div>
                <div id="yaku-unrecognized" style="color: #dc3545; margin-bottom: 5px;"></div>
                <div id="yaku-han" style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;"></div>
                <div id="yaku-points" style="font-weight: bold; font-size: 1.2em; color: #667eea;"></div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;" data-i18n="label_riichi_status">Á´ãÁõ¥ÊÉÖÂÜµÔºàÂãæÈÄâÁ´ãÁõ¥ÁöÑÁé©ÂÆ∂Ôºâ</label>
                <div style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="riichi-0">
                        <label for="riichi-0" id="riichi-label-0">Áé©ÂÆ∂1</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="riichi-1">
                        <label for="riichi-1" id="riichi-label-1">Áé©ÂÆ∂2</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="riichi-2">
                        <label for="riichi-2" id="riichi-label-2">Áé©ÂÆ∂3</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="riichi-3">
                        <label for="riichi-3" id="riichi-label-3">Áé©ÂÆ∂4</label>
                    </div>
                </div>
            </div>
            <button onclick="recordWin()" style="width: 100%; margin-top: 15px;" data-i18n="button_record_win">ËÆ∞ÂΩïÂíåÁâå</button>
            <div id="message"></div>
        </div>

        <!-- ËÆ∞ÂΩïÊµÅÂ±Ä -->
        <div class="section">
            <h2 data-i18n="section_record_ryuukyoku">ËÆ∞ÂΩïÊµÅÂ±Ä</h2>
            <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 5px;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;" data-i18n="label_tenpai_players">Âê¨ÁâåÁé©ÂÆ∂ÔºàÂãæÈÄâÂê¨ÁâåÁöÑÁé©ÂÆ∂Ôºâ</label>
                <div style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="tenpai-0">
                        <label for="tenpai-0" id="tenpai-label-0">Áé©ÂÆ∂1</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tenpai-1">
                        <label for="tenpai-1" id="tenpai-label-1">Áé©ÂÆ∂2</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tenpai-2">
                        <label for="tenpai-2" id="tenpai-label-2">Áé©ÂÆ∂3</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tenpai-3">
                        <label for="tenpai-3" id="tenpai-label-3">Áé©ÂÆ∂4</label>
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 5px;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;" data-i18n="label_riichi_status">Á´ãÁõ¥ÊÉÖÂÜµÔºàÂãæÈÄâÁ´ãÁõ¥ÁöÑÁé©ÂÆ∂Ôºâ</label>
                <div style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ryuukyoku-riichi-0">
                        <label for="ryuukyoku-riichi-0" id="ryuukyoku-riichi-label-0">Áé©ÂÆ∂1</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="ryuukyoku-riichi-1">
                        <label for="ryuukyoku-riichi-1" id="ryuukyoku-riichi-label-1">Áé©ÂÆ∂2</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="ryuukyoku-riichi-2">
                        <label for="ryuukyoku-riichi-2" id="ryuukyoku-riichi-label-2">Áé©ÂÆ∂3</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="ryuukyoku-riichi-3">
                        <label for="ryuukyoku-riichi-3" id="ryuukyoku-riichi-label-3">Áé©ÂÆ∂4</label>
                    </div>
                </div>
            </div>
            <button onclick="recordRyuukyoku()" style="width: 100%; background: #28a745;" data-i18n="button_record_ryuukyoku">ËÆ∞ÂΩïÊµÅÂ±Ä</button>
            <div id="ryuukyoku-message"></div>
        </div>

        <!-- ÂØπÂ±ÄÂéÜÂè≤ -->
        <div class="section">
            <h2 data-i18n="section_history">ÂØπÂ±ÄÂéÜÂè≤</h2>
            <button onclick="clearHistory()" style="margin-bottom: 15px; background: #dc3545;" data-i18n="button_clear_history">Ê∏ÖÁ©∫ÂéÜÂè≤</button>
            <div class="history" id="history"></div>
        </div>

        <!-- ÂØπÂ±ÄJSONÊëòË¶Å -->
        <div class="section">
            <h2 data-i18n="section_json">ÂØπÂ±ÄÊï∞ÊçÆÔºàJSONÔºâ</h2>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <pre id="game-summary-json" style="flex: 1; min-height: 160px; max-height: 240px; background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 5px; overflow: auto; white-space: pre; font-size: 0.8em; line-height: 1.35;"></pre>
                <button id="copy-game-summary" style="min-width: 120px; height: 40px;" data-i18n="button_copy">Â§çÂà∂Êï∞ÊçÆ</button>
            </div>
            <div id="copy-status" style="margin-top: 6px; font-size: 0.85em; color: #28a745;"></div>
        </div>
    </div>

    <script>
        // ÂΩπÁßçÊï∞ÊçÆÂ∫ì
        const params = new URLSearchParams(window.location.search);
        const LANGUAGE = (params.get('lang') || '').toLowerCase() === 'en' ? 'en' : 'zh';

        const yakuDatabase = {
            // 1Áï™ÂΩπ
            'Á´ãÁõ¥': 1, 'riichi': 1, '„É™„Éº„ÉÅ': 1,
            '‰∏ÄÂèë': 1, 'ippatsu': 1, '„Ç§„ÉÉ„Éë„ÉÑ': 1,
            'Èó®ÂâçÊ∏ÖËá™Êë∏Âíå': 1, 'Èó®Ê∏Ö': 1, 'tsumo': 1, '„ÉÑ„É¢': 1,
            'Âπ≥Âíå': 1, 'pinfu': 1, '„Éî„É≥„Éï': 1,
            'Êñ≠Âπ∫‰πù': 1, 'Êñ≠Âπ∫': 1, 'tanyao': 1, '„Çø„É≥„É§„Ç™': 1,
            '‰∏ÄÊùØÂè£': 1, 'iipeiko': 1, '„Ç§„Éº„Éö„Éº„Ç≥„Éº': 1,
            'Â≤≠‰∏äÂºÄËä±': 1, 'Â≤≠‰∏ä': 1, 'rinshan': 1, '„É™„É≥„Ç∑„É£„É≥': 1,
            'Êû™Êù†': 1, 'chankan': 1, '„ÉÅ„É£„É≥„Ç´„É≥': 1,
            'Êµ∑Â∫ïÊë∏Êúà': 1, 'Êµ∑Â∫ï': 1, 'haitei': 1, '„Éè„Ç§„ÉÜ„Ç§': 1,
            'Ê≤≥Â∫ïÊçûÈ±º': 1, 'Ê≤≥Â∫ï': 1, 'houtei': 1, '„Éõ„Ç¶„ÉÜ„Ç§': 1,
            'ÂΩπÁâåÁôΩ': 1, 'ÁôΩ': 1, 'haku': 1, '„Éè„ÇØ': 1,
            'ÂΩπÁâåÂèë': 1, 'Âèë': 1, 'hatsu': 1, '„Éè„ÉÑ': 1,
            'ÂΩπÁâå‰∏≠': 1, '‰∏≠': 1, 'chun': 1, '„ÉÅ„É•„É≥': 1,
            'Ëá™È£é‰∏ú': 1, '‰∏ú': 1, 'ton': 1, '„Éà„É≥': 1,
            'Ëá™È£éÂçó': 1, 'Âçó': 1, 'nan': 1, '„Éä„É≥': 1,
            'Ëá™È£éË•ø': 1, 'Ë•ø': 1, 'sha': 1, '„Ç∑„É£„Éº': 1,
            'Ëá™È£éÂåó': 1, 'Âåó': 1, 'pei': 1, '„Éö„Éº': 1,
            'Âú∫È£é‰∏ú': 1, 'Âú∫‰∏ú': 1,
            'Âú∫È£éÂçó': 1, 'Âú∫Âçó': 1,
            'Âú∫È£éË•ø': 1, 'Âú∫Ë•ø': 1,
            'Âú∫È£éÂåó': 1, 'Âú∫Âåó': 1,

            // 2Áï™ÂΩπ
            '‰∏âËâ≤ÂêåÈ°∫': 2, '‰∏âËâ≤': 2, 'sanshoku': 2, '„Çµ„É≥„Ç∑„Éß„ÇØ': 2,
            '‰∏ÄÊ∞îÈÄöË¥Ø': 2, '‰∏ÄÈÄö': 2, 'ikkitsuukan': 2, '„Ç§„ÉÉ„ÉÑ„Éº': 2,
            'Ê∑∑ÂÖ®Â∏¶Âπ∫‰πù': 2, 'Ê∑∑ÂÖ®': 2, 'chanta': 2, '„ÉÅ„É£„É≥„Çø': 2,
            '‰∏ÉÂØπÂ≠ê': 2, '‰∏ÉÂØπ': 2, 'chiitoitsu': 2, '„ÉÅ„Éº„Éà„Ç§„ÉÑ': 2,
            'ÂØπÂØπÂíå': 2, 'ÂØπÂØπ': 2, 'toitoi': 2, '„Éà„Ç§„Éà„Ç§': 2,
            '‰∏âÊöóÂàª': 2, 'sanankou': 2, '„Çµ„É≥„Ç¢„É≥„Ç≥„Éº': 2,
            '‰∏âÊù†Â≠ê': 2, 'sankantsu': 2, '„Çµ„É≥„Ç´„É≥„ÉÑ': 2,
            'Â∞è‰∏âÂÖÉ': 2, 'shousangen': 2, '„Ç∑„Éß„Ç¶„Çµ„É≥„Ç≤„É≥': 2,
            'Ê∑∑ËÄÅÂ§¥': 2, 'honroutou': 2, '„Éõ„É≥„É≠„Ç¶„Éà„Ç¶': 2,
            'ÂèåÁ´ãÁõ¥': 2, 'ÂèåÁ´ã': 2, 'daburu riichi': 2, '„ÉÄ„Éñ„É´„É™„Éº„ÉÅ': 2, 'wÁ´ãÁõ¥': 2,

            // 3Áï™ÂΩπ
            'Ê∑∑‰∏ÄËâ≤': 3, 'Ê∑∑‰∏Ä': 3, 'honitsu': 3, '„Éõ„É≥„Ç§„ÉÑ': 3,
            'Á∫ØÂÖ®Â∏¶Âπ∫‰πù': 3, 'Á∫ØÂÖ®': 3, 'junchan': 3, '„Ç∏„É•„É≥„ÉÅ„É£„É≥': 3,
            '‰∫åÊùØÂè£': 3, 'ryanpeikou': 3, '„É™„É£„É≥„Éö„Éº„Ç≥„Éº': 3,

            // 6Áï™ÂΩπ
            'Ê∏Ö‰∏ÄËâ≤': 6, 'Ê∏Ö‰∏Ä': 6, 'chinitsu': 6, '„ÉÅ„É≥„Ç§„ÉÑ': 6,

            // ÂΩπÊª° (13Áï™)
            'Â§©Âíå': 13, 'tenhou': 13, '„ÉÜ„É≥„Éõ„Ç¶': 13,
            'Âú∞Âíå': 13, 'chiihou': 13, '„ÉÅ„Éº„Éõ„Ç¶': 13,
            'Â§ß‰∏âÂÖÉ': 13, 'daisangen': 13, '„ÉÄ„Ç§„Çµ„É≥„Ç≤„É≥': 13,
            'ÂõõÊöóÂàª': 13, 'suuankou': 13, '„Çπ„Éº„Ç¢„É≥„Ç≥„Éº': 13,
            'Â≠ó‰∏ÄËâ≤': 13, 'tsuuiisou': 13, '„ÉÑ„Éº„Ç§„Éº„ÇΩ„Éº': 13,
            'Áªø‰∏ÄËâ≤': 13, 'ryuuiisou': 13, '„É™„É•„Éº„Ç§„Éº„ÇΩ„Éº': 13,
            'Ê∏ÖËÄÅÂ§¥': 13, 'chinroutou': 13, '„ÉÅ„É≥„É≠„Ç¶„Éà„Ç¶': 13,
            '‰πùËé≤ÂÆùÁÅØ': 13, 'chuuren': 13, '„ÉÅ„É•„Ç¶„É¨„É≥': 13,
            'ÂõõÊù†Â≠ê': 13, 'suukantsu': 13, '„Çπ„Éº„Ç´„É≥„ÉÑ': 13,
            'ÂõΩÂ£´Êó†Âèå': 13, 'ÂõΩÂ£´': 13, 'kokushi': 13, '„Ç≥„ÇØ„Ç∑': 13,
            'Â§ßÂõõÂñú': 13, 'daisuushi': 13, '„ÉÄ„Ç§„Çπ„Éº„Ç∑„Éº': 13,
            'Â∞èÂõõÂñú': 13, 'shousuushi': 13, '„Ç∑„Éß„Ç¶„Çπ„Éº„Ç∑„Éº': 13,

            // ÂèåÂÄçÂΩπÊª° (26Áï™)
            'ÂõõÊöóÂàªÂçïÈ™ë': 26, 'suuankou tanki': 26,
            'ÂõΩÂ£´Êó†ÂèåÂçÅ‰∏âÈù¢': 26, 'ÂõΩÂ£´ÂçÅ‰∏âÈù¢': 26, 'kokushi 13': 26,
            'Á∫ØÊ≠£‰πùËé≤ÂÆùÁÅØ': 26, 'Á∫ØÊ≠£‰πùËé≤': 26, 'chuuren 9': 26,
            'Â§ßÂõõÂñú': 26, 'daisuushi': 26
        };

        // ÂâØÈú≤Êó∂Áï™Êï∞‰ºöÂáèÂ∞ëÁöÑÂΩπÁßç
        const fuuroReducedYaku = {
            '‰∏âËâ≤ÂêåÈ°∫': -1, '‰∏âËâ≤': -1, 'sanshoku': -1, '„Çµ„É≥„Ç∑„Éß„ÇØ': -1,
            '‰∏ÄÊ∞îÈÄöË¥Ø': -1, '‰∏ÄÈÄö': -1, 'ikkitsuukan': -1, '„Ç§„ÉÉ„ÉÑ„Éº': -1,
            'Ê∑∑ÂÖ®Â∏¶Âπ∫‰πù': -1, 'Ê∑∑ÂÖ®': -1, 'chanta': -1, '„ÉÅ„É£„É≥„Çø': -1,
            'Á∫ØÂÖ®Â∏¶Âπ∫‰πù': -1, 'Á∫ØÂÖ®': -1, 'junchan': -1, '„Ç∏„É•„É≥„ÉÅ„É£„É≥': -1,
            'Ê∑∑‰∏ÄËâ≤': -1, 'Ê∑∑‰∏Ä': -1, 'honitsu': -1, '„Éõ„É≥„Ç§„ÉÑ': -1,
            'Ê∏Ö‰∏ÄËâ≤': -1, 'Ê∏Ö‰∏Ä': -1, 'chinitsu': -1, '„ÉÅ„É≥„Ç§„ÉÑ': -1
        };

        const I18N = {
            zh: {
                document_title: 'ËÆ°ÂàÜÂ∑•ÂÖ∑',
                title_main: 'üßÆ ËÆ°ÂàÜÂ∑•ÂÖ∑',
                section_current_scores: 'ÂΩìÂâçÁÇπÊï∞',
                label_riichi_sticks_prefix: '‰æõÊâò',
                label_riichi_sticks_suffix: 'Êú¨',
                game_end_title: 'üèÜ ÂØπÂ±ÄÁªìÊùü üèÜ',
                section_record_win: 'ËÆ∞ÂΩïÂíåÁâå',
                label_winner: 'ÂíåÁâåËÄÖ',
                label_loser: 'ÁÇπÁÇÆËÄÖÔºàËá™Êë∏ÈÄâÊã©"Ëá™Êë∏"Ôºâ',
                option_tsumo: 'Ëá™Êë∏',
                label_choose_yaku: 'ÈÄâÊã©ÂΩπÁßç',
                placeholder_yaku_search: 'ËæìÂÖ•ÊêúÁ¥¢Êàñ‰ªéÂàóË°®ÈÄâÊã©...',
                button_add_yaku: 'Ê∑ªÂä†',
                selected_yaku_placeholder: 'ËØ∑ÈÄâÊã©ÂΩπÁßç...',
                label_dora: 'ÂÆùÁâå',
                label_aka_dora: 'Ëµ§ÂÆùÁâå',
                label_ura_dora: 'ÈáåÂÆùÁâå',
                label_fu: 'Á¨¶Êï∞',
                option_fu: '{value}Á¨¶',
                option_fu_25: '25Á¨¶Ôºà‰∏ÉÂØπÂ≠êÔºâ',
                label_menzen: 'Èó®Ê∏Ö',
                preview_title: 'ËÆ°ÁÆóÈ¢ÑËßàÔºö',
                label_riichi_status: 'Á´ãÁõ¥ÊÉÖÂÜµÔºàÂãæÈÄâÁ´ãÁõ¥ÁöÑÁé©ÂÆ∂Ôºâ',
                label_tenpai_players: 'Âê¨ÁâåÁé©ÂÆ∂ÔºàÂãæÈÄâÂê¨ÁâåÁöÑÁé©ÂÆ∂Ôºâ',
                button_record_win: 'ËÆ∞ÂΩïÂíåÁâå',
                button_record_ryuukyoku: 'ËÆ∞ÂΩïÊµÅÂ±Ä',
                section_record_ryuukyoku: 'ËÆ∞ÂΩïÊµÅÂ±Ä',
                section_history: 'ÂØπÂ±ÄÂéÜÂè≤',
                button_clear_history: 'Ê∏ÖÁ©∫ÂéÜÂè≤',
                history_empty: 'ÊöÇÊó†ÂØπÂ±ÄËÆ∞ÂΩï',
                undo_button: 'Êí§ÈîÄ',
                section_json: 'ÂØπÂ±ÄÊï∞ÊçÆÔºàJSONÔºâ',
                button_copy: 'Â§çÂà∂Êï∞ÊçÆ',
                table_rank: 'ÊéíÂêç',
                table_player: 'Áé©ÂÆ∂',
                table_final_score: 'ÊúÄÁªàÁÇπÊï∞',
                table_raw_score: 'Á¥†ÁÇπÂ∑Æ',
                table_uma: 'È©¨ÁÇπ',
                table_riichi: '‰æõÊâò',
                table_total: 'ÊÄªÂæóÁÇπ',
                rank_suffix: '‰Ωç',
                round_suffix: 'Â±Ä',
                dealer_positions: ['‰∏úÂÆ∂', 'ÂçóÂÆ∂', 'Ë•øÂÆ∂', 'ÂåóÂÆ∂'],
                player_placeholder: 'Áé©ÂÆ∂{index}',
                copy_none: 'Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÊï∞ÊçÆ',
                copy_failed: 'Â§çÂà∂Â§±Ë¥•Ôºö',
                copy_auto: 'JSON Êï∞ÊçÆÂ∑≤Ëá™Âä®Â§çÂà∂',
                copy_success: 'Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø',
                copy_exec_failed: 'Êó†Ê≥ïÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø',
                msg_enter_yaku: 'ËØ∑ËæìÂÖ•ÊàñÈÄâÊã©ÂΩπÁßç',
                msg_unrecognized_yaku: 'Êú™ËØÜÂà´ÁöÑÂΩπÁßç: {name}',
                msg_duplicate_yaku: 'ËØ•ÂΩπÁßçÂ∑≤Ê∑ªÂä†',
                msg_same_player: 'ÂíåÁâåËÄÖÂíåÁÇπÁÇÆËÄÖ‰∏çËÉΩÊòØÂêå‰∏Ä‰∫∫ÔºÅ',
                msg_select_yaku_required: 'ËØ∑ÈÄâÊã©ÂΩπÁßçÔºÅ',
                msg_game_end: 'ÂØπÂ±ÄÁªìÊùüÔºÅ',
                msg_record_success: 'ËÆ∞ÂΩïÊàêÂäüÔºÅ',
                msg_ryuukyoku_success: 'ÊµÅÂ±ÄËÆ∞ÂΩïÊàêÂäüÔºÅ',
                msg_ryuukyoku_success_end: 'ÊµÅÂ±ÄËÆ∞ÂΩïÊàêÂäüÔºÅÂØπÂ±ÄÁªìÊùüÔºÅ',
                msg_no_history: 'Ê≤°ÊúâÂèØÊí§ÈîÄÁöÑËÆ∞ÂΩï',
                msg_undo_success: 'Â∑≤Êí§ÈîÄ‰∏ä‰∏ÄÂ±Ä',
                msg_clear_confirm: 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü',
                msg_history_cleared: 'Â∑≤Ê∏ÖÁ©∫ÂéÜÂè≤',
                msg_switch_rule_disabled: 'ÂØπÂ±ÄËøõË°å‰∏≠Êó†Ê≥ïÂàáÊç¢ËßÑÂàôÔºåËØ∑ÂÖàÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï',
                round_names: ['‰∏ú', 'Âçó', 'Ë•ø', 'Âåó'],
                honba_suffix: 'Êú¨Âú∫',
                dealer_label: 'Â∫ÑÂÆ∂',
                ron_text: 'ÁÇπÁÇÆ',
                tsumo_text: 'Ëá™Êë∏',
                total_han: 'ÊÄªÁï™Êï∞',
                han_unit: 'Áï™',
                fu_unit: 'Á¨¶',
                dealer_tsumo_points: 'Â∫ÑÂÆ∂Ëá™Êë∏: {points}ÁÇπ All (ÊØè‰∫∫ÊîØ‰ªò{points}ÁÇπ)',
                nondealer_tsumo_points: 'Èó≤ÂÆ∂Ëá™Êë∏: Èó≤ÂÆ∂ÂêÑ{small}ÁÇπ, Â∫ÑÂÆ∂{big}ÁÇπ (ÂÖ±{total}ÁÇπ)',
                dealer_ron_points: 'Â∫ÑÂÆ∂ÁÇπÁÇÆ: {points}ÁÇπ',
                nondealer_ron_points: 'Èó≤ÂÆ∂ÁÇπÁÇÆ: {points}ÁÇπ',
                extra_points_header: 'È¢ùÂ§ñ: ',
                extra_honba: 'Êú¨Âú∫+{points}ÁÇπ',
                extra_riichi: 'Á´ãÁõ¥Ê£í+{points}ÁÇπ',
                menzen_suffix_open: ' (ÂâØÈú≤)',
                riichi_players_label: 'Á´ãÁõ¥',
                yaku_label: 'ÂΩπ',
                dora_label_format: {
                    yaku: 'ÂΩπ{han}Áï™',
                    dora: 'ÂÆùÁâå{count}Áï™',
                    aka: 'Ëµ§{count}Áï™',
                    ura: 'Èáå{count}Áï™'
                },
                history_ryuukyoku: 'ÊµÅÂ±Ä',
                history_continue: 'ËøûÂ∫Ñ',
                history_change: 'ËΩÆÂ∫Ñ',
                history_tenpai_prefix: 'Âê¨Áâå: ',
                history_all_tenpai: 'ÂÖ®ÂëòÂê¨Áâå',
                history_all_noten: 'ÂÖ®ÂëòÊú™Âê¨Áâå',
                history_winner_summary: '{winner} ÂíåÁâå ({han}Áï™{fu}Á¨¶{dealer})',
                history_dealer_suffix: ' Â∫ÑÂÆ∂',
                history_loser_summary: '{loser} ¬∑ {points}',
                history_tsumo_summary: 'Ëá™Êë∏ ¬∑ {points}',
                history_extra_separator: ' ¬∑ ',
                summary_note_ron: 'Ëç£Âíå',
                summary_note_tsumo: 'Ëá™Êë∏',
                json_copy_button: 'Â§çÂà∂Êï∞ÊçÆ',
                history_score_changes: 'ÁÇπÊï∞ÂèòÂåñ'
            },
            en: {
                document_title: 'Game Tracker',
                title_main: 'üßÆ Game Tracker',
                section_current_scores: 'Current Scores',
                label_riichi_sticks_prefix: 'Riichi Sticks',
                label_riichi_sticks_suffix: '',
                game_end_title: 'üèÜ Game Finished üèÜ',
                section_record_win: 'Record Winning Hand',
                label_winner: 'Winner',
                label_loser: 'Loser (select "Tsumo" for self-draw)',
                option_tsumo: 'tsumo',
                label_choose_yaku: 'Select Yaku',
                placeholder_yaku_search: 'Type to search or choose from list...',
                button_add_yaku: 'Add',
                selected_yaku_placeholder: 'Please select yaku...',
                label_dora: 'Dora',
                label_aka_dora: 'Red Dora',
                label_ura_dora: 'Ura Dora',
                label_fu: 'Fu',
                option_fu: '{value} Fu',
                option_fu_25: '25 Fu (Seven Pairs)',
                label_menzen: 'Closed',
                preview_title: 'Preview',
                label_riichi_status: 'Riichi Status (check riichi players)',
                label_tenpai_players: 'Tenpai Players (check players who are tenpai)',
                button_record_win: 'Record Win',
                button_record_ryuukyoku: 'Record Draw',
                section_record_ryuukyoku: 'Record Draw',
                section_history: 'Game History',
                button_clear_history: 'Clear History',
                history_empty: 'No records yet',
                undo_button: 'Undo',
                section_json: 'Game Data (JSON)',
                button_copy: 'Copy Data',
                table_rank: 'Rank',
                table_player: 'Player',
                table_final_score: 'Final Score',
                table_raw_score: 'Raw Score',
                table_uma: 'Uma',
                table_riichi: 'Riichi Bonus',
                table_total: 'Total',
                rank_suffix: '',
                round_suffix: '',
                dealer_positions: ['East Seat', 'South Seat', 'West Seat', 'North Seat'],
                player_placeholder: 'Player {index}',
                copy_none: 'No data to copy',
                copy_failed: 'Copy failed: ',
                copy_auto: 'JSON copied automatically',
                copy_success: 'Copied to clipboard',
                copy_exec_failed: 'Unable to copy to clipboard',
                msg_enter_yaku: 'Please enter or select a yaku',
                msg_unrecognized_yaku: 'Unrecognized yaku: {name}',
                msg_duplicate_yaku: 'This yaku has already been added',
                msg_same_player: 'Winner and loser cannot be the same player.',
                msg_select_yaku_required: 'Please select at least one yaku.',
                msg_game_end: 'Game finished!',
                msg_record_success: 'Record saved!',
                msg_ryuukyoku_success: 'Draw recorded!',
                msg_ryuukyoku_success_end: 'Draw recorded! Game finished!',
                msg_no_history: 'No records to undo',
                msg_undo_success: 'Last record undone',
                msg_clear_confirm: 'Clear all records?',
                msg_history_cleared: 'History cleared',
                msg_switch_rule_disabled: 'Cannot switch rules during a game. Please clear the history first.',
                round_names: ['East', 'South', 'West', 'North'],
                honba_suffix: ' honba',
                dealer_label: 'Dealer',
                ron_text: 'Ron',
                tsumo_text: 'Self-draw',
                total_han: 'Total Han',
                han_unit: ' han',
                fu_unit: ' fu',
                dealer_tsumo_points: 'Dealer self-draw: {points} pts each',
                nondealer_tsumo_points: 'Non-dealer self-draw: others {small} pts, dealer {big} pts (total {total} pts)',
                dealer_ron_points: 'Dealer ron: {points} pts',
                nondealer_ron_points: 'Non-dealer ron: {points} pts',
                extra_points_header: 'Extra: ',
                extra_honba: 'Honba +{points} pts',
                extra_riichi: 'Riichi sticks +{points} pts',
                menzen_suffix_open: ' (Open)',
                riichi_players_label: 'Riichi',
                yaku_label: 'Yaku',
                dora_label_format: {
                    yaku: 'Yaku {han} han',
                    dora: 'Dora {count} han',
                    aka: 'Red {count} han',
                    ura: 'Ura {count} han'
                },
                history_ryuukyoku: 'Draw',
                history_continue: 'Dealer holds',
                history_change: 'Dealer passes',
                history_tenpai_prefix: 'Tenpai: ',
                history_all_tenpai: 'All tenpai',
                history_all_noten: 'No one tenpai',
                history_winner_summary: '{winner} wins ({han} han {fu} fu{dealer})',
                history_dealer_suffix: ' Dealer',
                history_loser_summary: '{loser}: {points}',
                history_tsumo_summary: 'Self-draw: {points}',
                history_extra_separator: ' ¬∑ ',
                summary_note_ron: 'Ron',
                summary_note_tsumo: 'Self-draw',
                json_copy_button: 'Copy Data',
                history_score_changes: 'Score Changes'
            }
        };

        function t(key, params = {}) {
            const langTable = I18N[LANGUAGE] || {};
            const fallbackTable = I18N.zh || {};
            let template = langTable[key];
            if (template === undefined) {
                template = fallbackTable[key];
            }
            if (typeof template === 'object') {
                return template;
            }
            if (typeof template !== 'string') {
                return key;
            }
            return template.replace(/\{(\w+)\}/g, (_, k) => {
                return params[k] !== undefined ? params[k] : `{${k}}`;
            });
        }

        function applyTranslations() {
            document.title = t('document_title');
            document.documentElement.lang = LANGUAGE === 'en' ? 'en' : 'zh-CN';

            document.querySelectorAll('.language-switcher a').forEach(link => {
                const linkLang = link.dataset.lang;
                if (linkLang) {
                    link.classList.toggle('active', linkLang === LANGUAGE);
                }
            });

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                const value = t(key);
                if (value !== undefined) {
                    el.innerHTML = value;
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (!key) return;
                const value = t(key);
                if (value !== undefined) {
                    el.setAttribute('placeholder', value);
                }
            });

            document.querySelectorAll('[data-i18n-option]').forEach(option => {
                const value = option.getAttribute('data-i18n-option');
                if (!value) return;
                if (value === 'fu_value') {
                    const fu = option.value;
                    option.textContent = fu === '25'
                        ? t('option_fu_25')
                        : t('option_fu', { value: fu });
                } else {
                    option.textContent = t(value);
                }
            });

            const copyBtn = document.getElementById('copy-game-summary');
            if (copyBtn) {
                copyBtn.textContent = t('button_copy');
            }

            const gameEndTitle = document.querySelector('#game-end-notice h3');
            if (gameEndTitle) {
                gameEndTitle.innerHTML = t('game_end_title');
            }
        }

        function getDefaultPlayerName(index) {
            return t('player_placeholder', { index: index + 1 });
        }

        function getRiichiKeyword() {
            return LANGUAGE === 'en' ? 'riichi' : 'Á´ãÁõ¥';
        }
        // ËÆ°ÁÆóÂΩπÁßçÊÄªÁï™Êï∞
        function calculateHanFromYaku(yakuText, isMenzen = true, doraCount = 0, akaDoraCount = 0, uraDoraCount = 0) {
            if (!yakuText || yakuText.trim() === '') {
                return {
                    totalHan: doraCount + akaDoraCount + uraDoraCount,
                    yakuHan: 0,
                    recognizedYaku: [],
                    unrecognizedYaku: [],
                    doraCount,
                    akaDoraCount,
                    uraDoraCount
                };
            }

            const yakuList = yakuText.trim().split(/\s+/);
            let yakuHan = 0;
            const recognizedYaku = [];
            const unrecognizedYaku = [];

            yakuList.forEach(yaku => {
                const yakuLower = yaku.toLowerCase();
                let han = 0;

                if (yakuDatabase[yakuLower] !== undefined) {
                    han = yakuDatabase[yakuLower];
                    recognizedYaku.push(yaku);
                } else if (yakuDatabase[yaku] !== undefined) {
                    han = yakuDatabase[yaku];
                    recognizedYaku.push(yaku);
                } else {
                    unrecognizedYaku.push(yaku);
                    return;
                }

                // Â¶ÇÊûú‰∏çÊòØÈó®Ê∏ÖÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂáèÂ∞ëÁï™Êï∞
                if (!isMenzen) {
                    if (fuuroReducedYaku[yakuLower] !== undefined) {
                        han += fuuroReducedYaku[yakuLower];
                    } else if (fuuroReducedYaku[yaku] !== undefined) {
                        han += fuuroReducedYaku[yaku];
                    }
                }

                yakuHan += han;
            });

            const totalHan = yakuHan + doraCount + akaDoraCount + uraDoraCount;

            return { totalHan, yakuHan, recognizedYaku, unrecognizedYaku, doraCount, akaDoraCount, uraDoraCount };
        }

        // Ëé∑ÂèñÂàùÂßãÁÇπÊï∞
        function getInitialScore(rule) {
            return rule === 'wrc' ? 30000 : 25000;
        }

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            players: ['', '', '', ''],
            scores: [25000, 25000, 25000, 25000],
            rule: 'mleague',
            round: 0,  // ÂΩìÂâçÂ±ÄÊï∞ (0-based, 0=‰∏ú1, 1=‰∏ú2, ..., 4=Âçó1, etc.)
            dealer: 0, // ÂΩìÂâçÂ∫ÑÂÆ∂‰ΩçÁΩÆ (0-3)
            honba: 0,  // Êú¨Âú∫Êï∞ÔºàËøûÂ∫ÑÊ¨°Êï∞Ôºâ
            riichiSticks: 0, // Á´ãÁõ¥Ê£íÊï∞Èáè
            history: [],
            gameEnded: false // ÂØπÂ±ÄÊòØÂê¶ÁªìÊùü
        };

        // Ê£ÄÊü•ÂØπÂ±ÄÊòØÂê¶ÁªìÊùüÔºàÂçó4Â±ÄÁªìÊùüÔºâ
        function checkGameEnd(isDealer, dealerWon) {
            // Âçó4Â±Ä = round 7Ôºà0=‰∏ú1, 1=‰∏ú2, 2=‰∏ú3, 3=‰∏ú4, 4=Âçó1, 5=Âçó2, 6=Âçó3, 7=Âçó4Ôºâ
            if (gameState.round === 7) {
                // Â¶ÇÊûú‰∏çÊòØÂ∫ÑÂÆ∂ÂíåÁâå/Âê¨ÁâåÔºåÂØπÂ±ÄÁªìÊùü
                if (!isDealer || !dealerWon) {
                    return true;
                }
            }
            return false;
        }

        // ËÆ°ÁÆóÊúÄÁªàÁªìÁÆó
        function calculateFinalResults() {
            const initialScore = getInitialScore(gameState.rule);

            // ËÆ°ÁÆóÊéíÂêç
            const playerResults = gameState.players.map((name, index) => ({
                index,
                name: name || getDefaultPlayerName(index),
                finalScore: gameState.scores[index],
                rawScore: gameState.scores[index] - initialScore // Á¥†ÁÇπÂ∑Æ
            }));

            // ÊåâÂàÜÊï∞ÊéíÂ∫è
            playerResults.sort((a, b) => b.finalScore - a.finalScore);

            // ÂàÜÈÖçÊéíÂêçÔºàÂ§ÑÁêÜÂêåÂàÜÊÉÖÂÜµÔºâ
            let currentRank = 1;
            for (let i = 0; i < playerResults.length; i++) {
                if (i > 0 && playerResults[i].finalScore < playerResults[i-1].finalScore) {
                    currentRank = i + 1;
                }
                playerResults[i].rank = currentRank;
            }

            // ‰∏Ä‰ΩçËé∑ÂæóÊâÄÊúâÁ´ãÁõ¥Ê£í
            const riichiBonus = gameState.riichiSticks * 1000;

            // ËÆ°ÁÆóÈ©¨ÁÇπ
            const umaPoints = gameState.rule === 'mleague'
                ? [45000, 5000, -15000, -35000]  // M-League
                : [30000, 10000, -10000, -30000]; // WRC

            playerResults.forEach((player, index) => {
                player.uma = umaPoints[index];
                player.riichiBonus = (index === 0) ? riichiBonus : 0; // ‰∏Ä‰ΩçËé∑ÂæóÁ´ãÁõ¥Ê£í
                player.totalScore = player.rawScore + player.uma + player.riichiBonus;
            });

            return playerResults;
        }

        // ÂΩìÂâçÈÄâÊã©ÁöÑÂΩπÁßç
        let selectedYaku = [];
        let lastCopiedSummary = '';
        let copyStatusTimeout = null;

        // Ëé∑ÂèñÊâÄÊúâÂΩπÁßçÁöÑÂêçÁß∞ÂàóË°®ÔºàÁî®‰∫édatalistÔºâ
        function getAllYakuNames() {
            const yakuNames = new Set();
            for (const key in yakuDatabase) {
                yakuNames.add(key);
            }

            // ÂàÜÁ±ªÔºö‰∏≠Êñá„ÄÅÊó•Êñá„ÄÅÁΩóÈ©¨Èü≥
            const chineseNames = [];
            const japaneseNames = [];
            const romajiNames = [];

            Array.from(yakuNames).forEach(name => {
                const firstChar = name.charCodeAt(0);
                // ‰∏≠ÊñáËåÉÂõ¥Ôºö0x4E00-0x9FFF
                if (firstChar >= 0x4E00 && firstChar <= 0x9FFF) {
                    chineseNames.push(name);
                }
                // Êó•ÊñáÂÅáÂêçËåÉÂõ¥Ôºö0x3040-0x30FF
                else if (firstChar >= 0x3040 && firstChar <= 0x30FF) {
                    japaneseNames.push(name);
                }
                // ÁΩóÈ©¨Èü≥ÔºàËã±ÊñáÂ≠óÊØçÔºâ
                else {
                    romajiNames.push(name);
                }
            });

            // ÂàÜÂà´ÊéíÂ∫èÂêéÂêàÂπ∂Ôºö‰∏≠Êñá -> ÁΩóÈ©¨Èü≥ -> Êó•Êñá
            chineseNames.sort();
            romajiNames.sort();
            japaneseNames.sort();

            if (LANGUAGE === 'en') {
                return [...romajiNames, ...chineseNames, ...japaneseNames];
            }
            return [...chineseNames, ...romajiNames, ...japaneseNames];
        }

        // Â°´ÂÖÖÂΩπÁßçdatalist
        function populateYakuDatalist() {
            const datalist = document.getElementById('yaku-datalist');
            const yakuNames = getAllYakuNames();

            datalist.innerHTML = '';
            yakuNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ´ãÁõ¥Áõ∏ÂÖ≥ÂΩπÁßç
        function isRiichiYaku(yakuName) {
            const riichiYaku = [
                'Á´ãÁõ¥', 'riichi', '„É™„Éº„ÉÅ',
                'ÂèåÁ´ãÁõ¥', 'ÂèåÁ´ã', 'daburu riichi', '„ÉÄ„Éñ„É´„É™„Éº„ÉÅ', 'wÁ´ãÁõ¥'
            ];
            return riichiYaku.some(y => yakuName.toLowerCase() === y.toLowerCase() || yakuName === y);
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊòØÈúÄË¶ÅÁ´ãÁõ¥ÁöÑÂΩπÁßç
        function needsRiichi(yakuName) {
            const needsRiichiYaku = [
                '‰∏ÄÂèë', 'ippatsu', '„Ç§„ÉÉ„Éë„ÉÑ',
                'Èó®ÂâçÊ∏ÖËá™Êë∏Âíå', 'Èó®Ê∏Ö', 'tsumo', '„ÉÑ„É¢'
            ];
            return needsRiichiYaku.some(y => yakuName.toLowerCase() === y.toLowerCase() || yakuName === y);
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏ÉÂØπÂ≠ê
        function isSevenPairsYaku(yakuName) {
            const normalized = yakuName.trim();
            const lower = normalized.toLowerCase();
            const variants = ['‰∏ÉÂØπÂ≠ê', '‰∏ÉÂØπ', 'chiitoitsu', '„ÉÅ„Éº„Éà„Ç§„ÉÑ'];
            return variants.some(variant => normalized === variant || lower === variant.toLowerCase());
        }

        // Ê†πÊçÆÂΩìÂâçÂΩπÁßçÊõ¥Êñ∞Èó®Ê∏ÖÂíåÁ¨¶Êï∞ÈîÅÂÆöÁä∂ÊÄÅ
        function updateLocks() {
            const menzenCheckbox = document.getElementById('menzen');
            const fuSelect = document.getElementById('fu');
            if (!menzenCheckbox || !fuSelect) return;

            const hasRiichi = selectedYaku.some(y => isRiichiYaku(y));
            const hasNeedsRiichi = selectedYaku.some(y => needsRiichi(y));
            const hasSevenPairs = selectedYaku.some(y => isSevenPairsYaku(y));

            if (hasSevenPairs) {
                fuSelect.value = '25';
                fuSelect.disabled = true;
            } else {
                fuSelect.disabled = false;
            }

            if (hasRiichi || hasNeedsRiichi || hasSevenPairs) {
                menzenCheckbox.checked = true;
                menzenCheckbox.disabled = true;
            } else {
                menzenCheckbox.disabled = false;
            }

            if (hasRiichi || hasNeedsRiichi) {
                const winnerInput = document.getElementById('winner');
                if (winnerInput) {
                    const winnerId = parseInt(winnerInput.value);
                    if (!Number.isNaN(winnerId)) {
                        const riichiCheckbox = document.getElementById(`riichi-${winnerId}`);
                        if (riichiCheckbox) {
                            riichiCheckbox.checked = true;
                        }
                    }
                }
            }
        }

        // Ê∑ªÂä†ÂΩπÁßç
        function addYaku() {
            const input = document.getElementById('yaku-search');
            const yakuName = input.value.trim();

            if (!yakuName) {
                showMessage(t('msg_enter_yaku'), 'error');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Âú®Êï∞ÊçÆÂ∫ì‰∏≠
            const yakuLower = yakuName.toLowerCase();
            if (yakuDatabase[yakuLower] === undefined && yakuDatabase[yakuName] === undefined) {
                showMessage(t('msg_unrecognized_yaku', { name: yakuName }), 'error');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊ∑ªÂä†
            if (selectedYaku.includes(yakuName)) {
                showMessage(t('msg_duplicate_yaku'), 'error');
                return;
            }

            selectedYaku.push(yakuName);

            // Â¶ÇÊûúÊ∑ªÂä†ÁöÑÊòØ‰∏ÄÂèëÊàñÈó®Ê∏ÖËá™Êë∏ÔºåËá™Âä®Ê∑ªÂä†Á´ãÁõ¥
            if (needsRiichi(yakuName)) {
                const hasRiichi = selectedYaku.some(y => isRiichiYaku(y));
                if (!hasRiichi) {
                    selectedYaku.push(getRiichiKeyword());
                }
            }

            updateLocks();
            input.value = '';
            updateSelectedYakuDisplay();
            updateYakuPreview();
        }

        // ÁßªÈô§ÂΩπÁßç
        function removeYaku(yakuName) {
            const index = selectedYaku.indexOf(yakuName);
            if (index > -1) {
                selectedYaku.splice(index, 1);

                updateLocks();
                updateSelectedYakuDisplay();
                updateYakuPreview();
            }
        }

        // Êõ¥Êñ∞Â∑≤ÈÄâÊã©ÂΩπÁßçÁöÑÊòæÁ§∫
        function updateSelectedYakuDisplay() {
            const container = document.getElementById('selected-yaku-list');

            if (selectedYaku.length === 0) {
                container.innerHTML = `<div style="color: #999;">${t('selected_yaku_placeholder')}</div>`;
                return;
            }

            const isMenzen = document.getElementById('menzen') ? document.getElementById('menzen').checked : true;

            container.innerHTML = selectedYaku.map(yaku => {
                let han = yakuDatabase[yaku] || yakuDatabase[yaku.toLowerCase()] || 0;

                // Â¶ÇÊûú‰∏çÊòØÈó®Ê∏ÖÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂáèÂ∞ëÁï™Êï∞
                if (!isMenzen) {
                    const yakuLower = yaku.toLowerCase();
                    if (fuuroReducedYaku[yakuLower] !== undefined) {
                        han += fuuroReducedYaku[yakuLower];
                    } else if (fuuroReducedYaku[yaku] !== undefined) {
                        han += fuuroReducedYaku[yaku];
                    }
                }

                return `
                    <span class="yaku-tag">
                        ${yaku} (${han}${t('han_unit')})
                        <button onclick="removeYaku('${yaku.replace(/'/g, "\\'")}')">√ó</button>
                    </span>
                `;
            }).join('');
        }

        // ÂàùÂßãÂåñ
        function init() {
            applyTranslations();
            loadState();
            populateYakuDatalist();
            updateDisplay();
            setupEventListeners();
            setupYakuInputListener();
        }

        // Êõ¥Êñ∞ÂΩπÁßçÈ¢ÑËßà
        function updateYakuPreview() {
            const fu = parseInt(document.getElementById('fu').value);
            const winnerId = parseInt(document.getElementById('winner').value) || 0;
            const loserValue = document.getElementById('loser').value;
            const menzenCheckbox = document.getElementById('menzen');
            let isMenzen = menzenCheckbox.checked;
            const isDealer = winnerId === gameState.dealer;
            const isTsumo = loserValue === 'tsumo';

            // Ëé∑ÂèñÂÆùÁâåÊï∞Èáè
            const doraCount = parseInt(document.getElementById('dora-count').value) || 0;
            const akaDoraCount = parseInt(document.getElementById('aka-dora-count').value) || 0;
            const uraDoraCount = parseInt(document.getElementById('ura-dora-count').value) || 0;

            // ÈáåÂÆùÂ≠òÂú®Êó∂Ëá™Âä®Ê∑ªÂä†Á´ãÁõ¥ÔºàËã•Â∞öÊú™Ê∑ªÂä†Ôºâ
            if (uraDoraCount > 0 && !selectedYaku.some(y => isRiichiYaku(y))) {
                selectedYaku.push(getRiichiKeyword());
                updateLocks();
                updateSelectedYakuDisplay();
                isMenzen = menzenCheckbox.checked;
            }

            if (selectedYaku.length === 0 && doraCount === 0 && akaDoraCount === 0 && uraDoraCount === 0) {
                document.getElementById('yaku-preview').style.display = 'none';
                return;
            }

            const yakuText = selectedYaku.join(' ');
            const result = calculateHanFromYaku(yakuText, isMenzen, doraCount, akaDoraCount, uraDoraCount);
            const previewDiv = document.getElementById('yaku-preview');
            previewDiv.style.display = 'block';

            // ÈöêËóèËØÜÂà´/Êú™ËØÜÂà´ÊñáÊú¨ÔºàÂõ†‰∏∫Áî®Êà∑ÊòØ‰ªéÂàóË°®ÈÄâÊã©ÁöÑÔºâ
            document.getElementById('yaku-recognized').textContent = '';
            document.getElementById('yaku-unrecognized').textContent = '';

            // ÊòæÁ§∫ÊÄªÁï™Êï∞
            const menzenText = isMenzen ? '' : t('menzen_suffix_open');
            let hanText = `${t('total_han')}: ${result.totalHan}${t('han_unit')}${menzenText}`;

            // ÊòæÁ§∫ÂÆùÁâåËØ¶ÊÉÖ
            const doraDetails = [];
            if (result.yakuHan > 0) doraDetails.push(LANGUAGE === 'en'
                ? `Yaku ${result.yakuHan}${t('han_unit')}`
                : `ÂΩπ${result.yakuHan}Áï™`);
            if (doraCount > 0) doraDetails.push(LANGUAGE === 'en'
                ? `Dora ${doraCount}${t('han_unit')}`
                : `ÂÆùÁâå${doraCount}Áï™`);
            if (akaDoraCount > 0) doraDetails.push(LANGUAGE === 'en'
                ? `Red ${akaDoraCount}${t('han_unit')}`
                : `Ëµ§${akaDoraCount}Áï™`);
            if (uraDoraCount > 0) doraDetails.push(LANGUAGE === 'en'
                ? `Ura ${uraDoraCount}${t('han_unit')}`
                : `Èáå${uraDoraCount}Áï™`);

            if (doraDetails.length > 0) {
                hanText += ` (${doraDetails.join(' + ')})`;
            }

            document.getElementById('yaku-han').textContent = hanText;

            // ËÆ°ÁÆóÁÇπÊï∞
            const points = calculatePoints(result.totalHan, fu, isDealer, isTsumo, gameState.rule);
            let pointsText = '';
            if (isTsumo) {
                if (isDealer) {
                    pointsText = t('dealer_tsumo_points', { points: points[0] });
                } else {
                    pointsText = t('nondealer_tsumo_points', { small: points[0], big: points[1], total: points[0]*2 + points[1] });
                }
            } else {
                pointsText = isDealer
                    ? t('dealer_ron_points', { points })
                    : t('nondealer_ron_points', { points });
            }

            // Ê∑ªÂä†Êú¨Âú∫ÂíåÁ´ãÁõ¥Ê£í‰ø°ÊÅØ
            const honbaPoints = gameState.honba * 300;
            const riichiPoints = gameState.riichiSticks * 1000;
            if (honbaPoints > 0 || riichiPoints > 0) {
                pointsText += `\n${t('extra_points_header')}`;
                if (honbaPoints > 0) pointsText += `${t('extra_honba', { points: honbaPoints })} `;
                if (riichiPoints > 0) pointsText += t('extra_riichi', { points: riichiPoints });
            }

            document.getElementById('yaku-points').textContent = pointsText;
            document.getElementById('yaku-points').style.whiteSpace = 'pre-line';
        }

        // ËÆæÁΩÆÂΩπÁßçËæìÂÖ•ÁõëÂê¨Âô®
        function setupYakuInputListener() {
            const yakuSearch = document.getElementById('yaku-search');
            const fuSelect = document.getElementById('fu');
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser');
            const menzenCheckbox = document.getElementById('menzen');
            const doraCount = document.getElementById('dora-count');
            const akaDoraCount = document.getElementById('aka-dora-count');
            const uraDoraCount = document.getElementById('ura-dora-count');

            // ÊîØÊåÅEnterÈîÆÊ∑ªÂä†
            yakuSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addYaku();
                }
            });

            // ÂΩìÈÄâÊã©ÊîπÂèòÊó∂Êõ¥Êñ∞È¢ÑËßà
            fuSelect.addEventListener('change', updateYakuPreview);
            winnerSelect.addEventListener('change', () => {
                updateLocks();
                updateYakuPreview();
            });
            loserSelect.addEventListener('change', updateYakuPreview);
            menzenCheckbox.addEventListener('change', () => {
                updateSelectedYakuDisplay(); // Êõ¥Êñ∞ÂΩπÁßçÊ†áÁ≠æÁöÑÁï™Êï∞
                updateYakuPreview();
            });

            // ÂÆùÁâåÊï∞ÈáèÊîπÂèòÊó∂Êõ¥Êñ∞È¢ÑËßà
            doraCount.addEventListener('input', updateYakuPreview);
            akaDoraCount.addEventListener('input', updateYakuPreview);
            uraDoraCount.addEventListener('input', updateYakuPreview);
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂ÂêçÂ≠ó
        function updatePlayerName(index, name) {
            gameState.players[index] = name;
            saveState();
            updateDisplay();
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
        function setupEventListeners() {
            // ËßÑÂàôÈÄâÊã©
            document.querySelectorAll('.rule-btn-compact').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Â¶ÇÊûúÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢ÂàáÊç¢ËßÑÂàô
                    if (gameState.history.length > 0) {
                        showMessage(t('msg_switch_rule_disabled'), 'error');
                        return;
                    }

                    const newRule = e.target.dataset.rule;

                    // Â¶ÇÊûúÂàáÊç¢ËßÑÂàôÔºåÊõ¥Êñ∞ÂàùÂßãÁÇπÊï∞
                    if (gameState.rule !== newRule) {
                        const initialScore = getInitialScore(newRule);
                        gameState.scores = [initialScore, initialScore, initialScore, initialScore];
                    }

                    document.querySelectorAll('.rule-btn-compact').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    gameState.rule = newRule;
                    saveState();
                    updateDisplay();
                });
            });

            // ÊµÅÂ±ÄÁïåÈù¢ÔºöÁ´ãÁõ¥Ëá™Âä®ÂãæÈÄâÂê¨Áâå
            for (let i = 0; i < 4; i++) {
                const riichiCheckbox = document.getElementById(`ryuukyoku-riichi-${i}`);
                const tenpaiCheckbox = document.getElementById(`tenpai-${i}`);
                if (!riichiCheckbox || !tenpaiCheckbox) continue;
                riichiCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        tenpaiCheckbox.checked = true;
                    }
                });
            }

            const copyBtn = document.getElementById('copy-game-summary');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => copyGameSummary(false));
            }
        }

        // ÊòæÁ§∫ÊúÄÁªàÁªìÁÆó
        function showFinalResults() {
            const results = calculateFinalResults();
            const finalResultsDiv = document.getElementById('final-results');

            let html = '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 5px; overflow: hidden;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += `<th style="padding: 10px;">${t('table_rank')}</th>`;
            html += `<th style="padding: 10px;">${t('table_player')}</th>`;
            html += `<th style="padding: 10px;">${t('table_final_score')}</th>`;
            html += `<th style="padding: 10px;">${t('table_raw_score')}</th>`;
            html += `<th style="padding: 10px;">${t('table_uma')}</th>`;
            html += `<th style="padding: 10px;">${t('table_riichi')}</th>`;
            html += `<th style="padding: 10px;">${t('table_total')}</th>`;
            html += '</tr></thead><tbody>';

            results.forEach((player, index) => {
                const rankEmoji = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£'][index] || '';
                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${rowColor}; text-align: center;">`;
                html += `<td style="padding: 10px; font-size: 1.2em;">${rankEmoji} ${player.rank}${t('rank_suffix')}</td>`;
                html += `<td style="padding: 10px; font-weight: bold;">${player.name}</td>`;
                html += `<td style="padding: 10px;">${player.finalScore.toLocaleString()}</td>`;
                html += `<td style="padding: 10px; color: ${player.rawScore >= 0 ? '#28a745' : '#dc3545'};">${player.rawScore >= 0 ? '+' : ''}${player.rawScore.toLocaleString()}</td>`;
                html += `<td style="padding: 10px; color: ${player.uma >= 0 ? '#28a745' : '#dc3545'};">${player.uma >= 0 ? '+' : ''}${player.uma.toLocaleString()}</td>`;
                html += `<td style="padding: 10px; color: ${player.riichiBonus > 0 ? '#28a745' : '#666'};">${player.riichiBonus > 0 ? '+' : ''}${player.riichiBonus.toLocaleString()}</td>`;
                html += `<td style="padding: 10px; font-weight: bold; font-size: 1.1em; color: ${player.totalScore >= 0 ? '#28a745' : '#dc3545'};">${player.totalScore >= 0 ? '+' : ''}${player.totalScore.toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            finalResultsDiv.innerHTML = html;
            document.getElementById('game-end-notice').style.display = 'block';
        }

        // Êõ¥Êñ∞ÊòæÁ§∫
        function updateDisplay() {
            // Êõ¥Êñ∞Â±ÄÊï∞ÊòæÁ§∫
            const roundNames = t('round_names');
            const roundIndex = Math.floor(gameState.round / 4);
            const subRound = (gameState.round % 4) + 1;
            let roundName;
            if (LANGUAGE === 'en') {
                roundName = `${roundNames[roundIndex % 4]} ${subRound}`;
            } else {
                roundName = `${roundNames[roundIndex % 4]}${subRound}${t('round_suffix')}`;
            }
            document.getElementById('current-round').textContent = roundName;

            // Êõ¥Êñ∞Êú¨Âú∫Êï∞ÊòæÁ§∫ÔºàÂØπÂ±ÄÁªìÊùüÂêé‰∏çÊòæÁ§∫Ôºâ
            const honbaElement = document.getElementById('honba-display');
            if (gameState.gameEnded) {
                honbaElement.style.display = 'none';
            } else {
                honbaElement.style.display = 'inline';
                honbaElement.textContent = `${gameState.honba}${t('honba_suffix')}`;
            }

            // Êõ¥Êñ∞Á´ãÁõ¥Ê£íÊòæÁ§∫
            document.getElementById('riichi-sticks').textContent = `${gameState.riichiSticks}`;

            // Êõ¥Êñ∞ÁÇπÊï∞ÊòæÁ§∫
            const scoresDiv = document.getElementById('scores-display');
            scoresDiv.innerHTML = '';
            const positions = t('dealer_positions');
            gameState.players.forEach((name, i) => {
                const isDealer = i === gameState.dealer;
                const dealerClass = isDealer ? 'dealer' : '';
                const dealerBadge = isDealer ? ' üÄÑ' : '';
                scoresDiv.innerHTML += `
                    <div class="player-score ${dealerClass}">
                        <input type="text"
                               id="player-name-${i}"
                               value="${name}"
                               placeholder="${positions[i] || getDefaultPlayerName(i)}"
                               onchange="updatePlayerName(${i}, this.value)"
                               ${gameState.gameEnded ? 'disabled' : ''}>
                        <div class="score">${gameState.scores[i].toLocaleString()}${dealerBadge}</div>
                    </div>
                `;
            });

            // Ê£ÄÊü•ÂØπÂ±ÄÊòØÂê¶ÁªìÊùü
            if (gameState.gameEnded) {
                showFinalResults();
            } else {
                document.getElementById('game-end-notice').style.display = 'none';
            }

            // Êõ¥Êñ∞Á´ãÁõ¥ÂíåÂê¨ÁâåÈÄâÈ°πÁöÑÊ†áÁ≠æ
            for (let i = 0; i < 4; i++) {
                const playerName = gameState.players[i] || getDefaultPlayerName(i);
                document.getElementById(`riichi-label-${i}`).textContent = playerName;
                document.getElementById(`tenpai-label-${i}`).textContent = playerName;
                document.getElementById(`ryuukyoku-riichi-label-${i}`).textContent = playerName;
            }

            // Ê†πÊçÆÂéÜÂè≤ËÆ∞ÂΩïÊòØÂê¶Â≠òÂú®ÔºåÁ¶ÅÁî®ÊàñÂêØÁî®ËßÑÂàôÊåâÈíÆ
            const hasHistory = gameState.history.length > 0;
            document.querySelectorAll('.rule-btn-compact').forEach(btn => {
                btn.disabled = hasHistory || gameState.gameEnded;
            });

            // Êõ¥Êñ∞‰∏ãÊãâÈÄâÈ°π
            updateSelects();

            // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
            updateHistory();

            // ÂØπÂ±ÄÁªìÊùüÂêéÂ∞ÅÈîÅÊâÄÊúâËæìÂÖ•ÂíåÊåâÈíÆ
            if (gameState.gameEnded) {
                // Á¶ÅÁî®ÂíåÁâåÁõ∏ÂÖ≥ÁöÑÊâÄÊúâËæìÂÖ•
                document.getElementById('winner').disabled = true;
                document.getElementById('loser').disabled = true;
                document.getElementById('fu').disabled = true;
                document.getElementById('menzen').disabled = true;
                document.getElementById('yaku-search').disabled = true;
                document.querySelector('.yaku-selector button').disabled = true;
                document.getElementById('dora-count').disabled = true;
                document.getElementById('aka-dora-count').disabled = true;
                document.getElementById('ura-dora-count').disabled = true;
                document.querySelector('button[onclick="recordWin()"]').disabled = true;

                // Á¶ÅÁî®ÊµÅÂ±ÄÁõ∏ÂÖ≥ÁöÑÊâÄÊúâËæìÂÖ•
                for (let i = 0; i < 4; i++) {
                    document.getElementById(`tenpai-${i}`).disabled = true;
                    document.getElementById(`ryuukyoku-riichi-${i}`).disabled = true;
                    document.getElementById(`riichi-${i}`).disabled = true;
                }
                document.querySelector('button[onclick="recordRyuukyoku()"]').disabled = true;
            } else {
                // ÂêØÁî®ÊâÄÊúâËæìÂÖ•
                document.getElementById('winner').disabled = false;
                document.getElementById('loser').disabled = false;
                document.getElementById('fu').disabled = false;
                document.getElementById('menzen').disabled = false;
                document.getElementById('yaku-search').disabled = false;
                document.querySelector('.yaku-selector button').disabled = false;
                document.getElementById('dora-count').disabled = false;
                document.getElementById('aka-dora-count').disabled = false;
                document.getElementById('ura-dora-count').disabled = false;
                document.querySelector('button[onclick="recordWin()"]').disabled = false;

                for (let i = 0; i < 4; i++) {
                    document.getElementById(`tenpai-${i}`).disabled = false;
                    document.getElementById(`ryuukyoku-riichi-${i}`).disabled = false;
                    document.getElementById(`riichi-${i}`).disabled = false;
                }
                document.querySelector('button[onclick="recordRyuukyoku()"]').disabled = false;
            }

            if (!gameState.gameEnded) {
                updateLocks();
            }

            updateGameSummary();
        }

        // Êõ¥Êñ∞‰∏ãÊãâÈÄâÈ°π
        function updateSelects() {
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser');

            winnerSelect.innerHTML = '';
            loserSelect.innerHTML = `<option value="tsumo">${t('option_tsumo')}</option>`;

            gameState.players.forEach((name, i) => {
                const playerName = name || getDefaultPlayerName(i);
                winnerSelect.innerHTML += `<option value="${i}">${playerName}</option>`;
                loserSelect.innerHTML += `<option value="${i}">${playerName}</option>`;
            });
        }

        // ËÆ°ÁÆóÁÇπÊï∞
        function calculatePoints(han, fu, isDealer, isTsumo, rule) {
            // ÂΩπÊª°Âèä‰ª•‰∏ä
            if (han >= 13) {
                return isDealer
                    ? (isTsumo ? [16000, 16000, 16000] : 48000)
                    : (isTsumo ? [8000, 16000, 8000] : 32000);
            }
            if (han >= 11) {
                return isDealer
                    ? (isTsumo ? [12000, 12000, 12000] : 36000)
                    : (isTsumo ? [6000, 12000, 6000] : 24000);
            }
            if (han >= 8) {
                return isDealer
                    ? (isTsumo ? [8000, 8000, 8000] : 24000)
                    : (isTsumo ? [4000, 8000, 4000] : 16000);
            }
            if (han >= 6) {
                return isDealer
                    ? (isTsumo ? [6000, 6000, 6000] : 18000)
                    : (isTsumo ? [3000, 6000, 3000] : 12000);
            }

            // ËÆ°ÁÆóÂü∫Êú¨ÁÇπ
            let basePoints = fu * Math.pow(2, 2 + han);

            // Êª°Ë¥ØÂà§ÂÆöÔºàWRCÂíåM-LeagueËßÑÂàô‰∏çÂêåÔºâ
            if (rule === 'wrc') {
                // WRCËßÑÂàôÔºöÂè™Êúâ5Áï™Âèä‰ª•‰∏äÔºåÊàñ4Áï™40Á¨¶+ÔºåÊàñ3Áï™70Á¨¶+ÊâçÊòØÊª°Ë¥Ø
                if (han >= 5 || (han >= 4 && fu >= 40) || (han >= 3 && fu >= 70)) {
                    return isDealer
                        ? (isTsumo ? [4000, 4000, 4000] : 12000)
                        : (isTsumo ? [2000, 4000, 2000] : 8000);
                }
            } else {
                // M-LeagueËßÑÂàôÔºö4Áï™30Á¨¶‰πüÊåâÊª°Ë¥ØËÆ°ÁÆó
                if (han >= 5 || (han >= 4 && fu >= 30) || (han >= 3 && fu >= 70)) {
                    return isDealer
                        ? (isTsumo ? [4000, 4000, 4000] : 12000)
                        : (isTsumo ? [2000, 4000, 2000] : 8000);
                }
            }

            // ÊôÆÈÄöËÆ°ÁÆó
            if (isTsumo) {
                if (isDealer) {
                    const payment = Math.ceil(basePoints * 2 / 100) * 100;
                    return [payment, payment, payment];
                } else {
                    const dealerPayment = Math.ceil(basePoints * 2 / 100) * 100;
                    const otherPayment = Math.ceil(basePoints / 100) * 100;
                    return [otherPayment, dealerPayment, otherPayment];
                }
            } else {
                if (isDealer) {
                    return Math.ceil(basePoints * 6 / 100) * 100;
                } else {
                    return Math.ceil(basePoints * 4 / 100) * 100;
                }
            }
        }

        // ËÆ∞ÂΩïÂíåÁâå
        function recordWin() {
            const winnerId = parseInt(document.getElementById('winner').value);
            const loserValue = document.getElementById('loser').value;
            const fu = parseInt(document.getElementById('fu').value);
            const isMenzen = document.getElementById('menzen').checked;
            const isDealer = winnerId === gameState.dealer;  // Ëá™Âä®Âà§Êñ≠ÊòØÂê¶Â∫ÑÂÆ∂
            const isTsumo = loserValue === 'tsumo';
            const loserId = isTsumo ? -1 : parseInt(loserValue);
            const doraCount = parseInt(document.getElementById('dora-count').value) || 0;
            const akaDoraCount = parseInt(document.getElementById('aka-dora-count').value) || 0;
            const uraDoraCount = parseInt(document.getElementById('ura-dora-count').value) || 0;

            // È™åËØÅ
            if (!isTsumo && winnerId === loserId) {
                showMessage(t('msg_same_player'), 'error');
                return;
            }

            // È™åËØÅÂΩπÁßç
            if (selectedYaku.length === 0) {
                showMessage(t('msg_select_yaku_required'), 'error');
                return;
            }

            // ËÆ°ÁÆóÁï™Êï∞
            const yakuText = selectedYaku.join(' ');
            const yakuResult = calculateHanFromYaku(
                yakuText,
                isMenzen,
                doraCount,
                akaDoraCount,
                uraDoraCount
            );
            const han = yakuResult.totalHan;

            // Ëé∑ÂèñÁ´ãÁõ¥ÊÉÖÂÜµ
            const riichiPlayers = [];
            for (let i = 0; i < 4; i++) {
                if (document.getElementById(`riichi-${i}`).checked) {
                    riichiPlayers.push(i);
                }
            }

            // ËÆ°ÁÆóÂü∫Êú¨ÁÇπÊï∞
            const points = calculatePoints(han, fu, isDealer, isTsumo, gameState.rule);
            const newScores = [...gameState.scores];

            // ËÆ°ÁÆóÊú¨Âú∫Ê£íÁÇπÊï∞
            const honbaPoints = gameState.honba * 300;

            if (isTsumo) {
                // Ëá™Êë∏
                const [pay0, pay1, pay2] = points;
                newScores.forEach((score, i) => {
                    if (i !== winnerId) {
                        if (i === 0) {
                            newScores[i] -= pay1;
                            newScores[winnerId] += pay1;
                        } else {
                            const payment = isDealer ? pay0 : (winnerId === 0 ? pay1 : pay0);
                            newScores[i] -= payment;
                            newScores[winnerId] += payment;
                        }
                    }
                });
                // Ëá™Êë∏Êó∂ÔºåÊú¨Âú∫Ê£íÁî±ÂÖ∂‰ªñ‰∏âÂÆ∂Âπ≥ÂàÜÊîØ‰ªò
                const honbaPerPlayer = Math.floor(honbaPoints / 3);
                newScores.forEach((score, i) => {
                    if (i !== winnerId) {
                        newScores[i] -= honbaPerPlayer;
                        newScores[winnerId] += honbaPerPlayer;
                    }
                });
            } else {
                // ÁÇπÁÇÆ
                newScores[loserId] -= points;
                newScores[winnerId] += points;
                // ÁÇπÁÇÆÊó∂ÔºåÊú¨Âú∫Ê£íÁî±ÁÇπÁÇÆËÄÖÊîØ‰ªò
                newScores[loserId] -= honbaPoints;
                newScores[winnerId] += honbaPoints;
            }

            // Êâ£Èô§Á´ãÁõ¥Áé©ÂÆ∂ÁöÑ1000ÁÇπ
            riichiPlayers.forEach(playerId => {
                newScores[playerId] -= 1000;
            });

            // Á´ãÁõ¥Ê£íÁî±ÂíåÁâåËÄÖÊî∂ÂèñÔºàÂåÖÊã¨‰πãÂâçÁßØÁ¥ØÁöÑÁ´ãÁõ¥Ê£í + Êú¨Â±ÄÊñ∞Â¢ûÁöÑÁ´ãÁõ¥Ê£íÔºâ
            const totalRiichiSticks = gameState.riichiSticks + riichiPlayers.length;
            const totalRiichiPoints = totalRiichiSticks * 1000;
            newScores[winnerId] += totalRiichiPoints;

            // ËÆ∞ÂΩïÂéÜÂè≤
            const record = {
                type: 'win',
                winnerId,
                loserId,
                isTsumo,
                han,
                fu,
                yaku: yakuResult.recognizedYaku.join(' '),
                yakuHan: yakuResult.yakuHan,
                doraCount: yakuResult.doraCount,
                akaDoraCount: yakuResult.akaDoraCount,
                uraDoraCount: yakuResult.uraDoraCount,
                isMenzen,
                isDealer,
                points,
                riichiPlayers: [...riichiPlayers],
                honbaPoints,
                riichiPoints: totalRiichiPoints,
                scoreBefore: [...gameState.scores],
                scoreAfter: [...newScores],
                roundBefore: gameState.round,
                dealerBefore: gameState.dealer,
                honbaBefore: gameState.honba,
                riichiSticksBefore: gameState.riichiSticks,
                timestamp: Date.now()
            };

            gameState.history.push(record);
            gameState.scores = newScores;

            // Êõ¥Êñ∞Á´ãÁõ¥Ê£íÊï∞ÈáèÔºàÂíåÁâåÂêéÊâÄÊúâÁ´ãÁõ¥Ê£íË¢´ÂíåÁâåËÄÖÊãøËµ∞ÔºåÊ∏ÖÈõ∂Ôºâ
            gameState.riichiSticks = 0;

            // Ê£ÄÊü•ÂØπÂ±ÄÊòØÂê¶ÁªìÊùü
            if (checkGameEnd(isDealer, true)) {
                gameState.gameEnded = true;
            }

            // Êõ¥Êñ∞Â∫ÑÂÆ∂ÂíåÂ±ÄÊï∞
            if (isDealer) {
                // Â∫ÑÂÆ∂ÂíåÁâåÔºåËøûÂ∫ÑÔºöÂ±ÄÊï∞‰∏çÂèòÔºåÊú¨Âú∫+1
                gameState.honba++;
            } else {
                // Â∫ÑÂÆ∂Ê≤°ÂíåÁâåÔºåËΩÆÂ∫ÑÔºöÂ∫ÑÂÆ∂ËΩÆÊç¢ÔºåÂ±ÄÊï∞+1ÔºåÊú¨Âú∫ÂΩí0
                gameState.dealer = (gameState.dealer + 1) % 4;
                gameState.round++;
                gameState.honba = 0;
            }

            // Ê∏ÖÈô§Â§çÈÄâÊ°ÜÂíåÂΩπÁßçÈÄâÊã©
            for (let i = 0; i < 4; i++) {
                document.getElementById(`riichi-${i}`).checked = false;
            }
            selectedYaku = [];
            updateSelectedYakuDisplay();
            document.getElementById('yaku-preview').style.display = 'none';
            document.getElementById('menzen').checked = true; // ÈáçÁΩÆ‰∏∫Èó®Ê∏Ö
            document.getElementById('menzen').disabled = false; // Ëß£ÈîÅÈó®Ê∏ÖÂ§çÈÄâÊ°Ü
            document.getElementById('dora-count').value = 0;
            document.getElementById('aka-dora-count').value = 0;
            document.getElementById('ura-dora-count').value = 0;
            updateLocks();

            saveState();
            updateDisplay();
            updateYakuPreview();

            if (gameState.gameEnded) {
                showMessage(t('msg_game_end'), 'success');
            } else {
                showMessage(t('msg_record_success'), 'success');
            }
        }

        // ËÆ∞ÂΩïÊµÅÂ±Ä
        function recordRyuukyoku() {
            // Ëé∑ÂèñÂê¨ÁâåÁé©ÂÆ∂
            const tenpaiPlayers = [];
            for (let i = 0; i < 4; i++) {
                if (document.getElementById(`tenpai-${i}`).checked) {
                    tenpaiPlayers.push(i);
                }
            }

            // Ëé∑ÂèñÁ´ãÁõ¥Áé©ÂÆ∂
            const riichiPlayers = [];
            for (let i = 0; i < 4; i++) {
                if (document.getElementById(`ryuukyoku-riichi-${i}`).checked) {
                    riichiPlayers.push(i);
                }
            }

            const tenpaiCount = tenpaiPlayers.length;
            const newScores = [...gameState.scores];

            // ËÆ°ÁÆóÂê¨ÁâåË¥π
            // 0‰∫∫Âê¨ÁâåÊàñ4‰∫∫Âê¨ÁâåÔºö‰∏çÁßªÂä®ÁÇπÊï∞
            // 1‰∫∫Âê¨ÁâåÔºöÂÖ∂‰ªñ3‰∫∫ÂêÑÁªô1000ÁÇπ
            // 2‰∫∫Âê¨ÁâåÔºöÊú™Âê¨ÁâåÁöÑ2‰∫∫ÂêÑÁªô1500ÁÇπ
            // 3‰∫∫Âê¨ÁâåÔºöÊú™Âê¨ÁâåÁöÑ1‰∫∫Áªô3000ÁÇπ
            if (tenpaiCount === 1) {
                const tenpaiPlayer = tenpaiPlayers[0];
                for (let i = 0; i < 4; i++) {
                    if (i !== tenpaiPlayer) {
                        newScores[i] -= 1000;
                        newScores[tenpaiPlayer] += 1000;
                    }
                }
            } else if (tenpaiCount === 2) {
                for (let i = 0; i < 4; i++) {
                    if (tenpaiPlayers.includes(i)) {
                        newScores[i] += 1500;
                    } else {
                        newScores[i] -= 1500;
                    }
                }
            } else if (tenpaiCount === 3) {
                for (let i = 0; i < 4; i++) {
                    if (tenpaiPlayers.includes(i)) {
                        newScores[i] += 1000;
                    } else {
                        newScores[i] -= 3000;
                    }
                }
            }

            // Êâ£Èô§Á´ãÁõ¥Áé©ÂÆ∂ÁöÑ1000ÁÇπ
            riichiPlayers.forEach(playerId => {
                newScores[playerId] -= 1000;
            });

            // Âà§Êñ≠ÊòØÂê¶ËøûÂ∫Ñ
            const dealerTenpai = tenpaiPlayers.includes(gameState.dealer);

            // ËÆ∞ÂΩïÂéÜÂè≤
            const record = {
                type: 'ryuukyoku',
                tenpaiPlayers: [...tenpaiPlayers],
                riichiPlayers: [...riichiPlayers],
                dealerTenpai,
                scoreBefore: [...gameState.scores],
                scoreAfter: [...newScores],
                roundBefore: gameState.round,
                dealerBefore: gameState.dealer,
                honbaBefore: gameState.honba,
                riichiSticksBefore: gameState.riichiSticks,
                timestamp: Date.now()
            };

            gameState.history.push(record);
            gameState.scores = newScores;

            // Êõ¥Êñ∞Á´ãÁõ¥Ê£íÔºàÊµÅÂ±ÄÂêéÁ´ãÁõ¥Ê£íÁïôÂú®Ê°å‰∏äÔºåÂπ∂Â¢ûÂä†Êú¨Â±ÄÊñ∞Â¢ûÁöÑÁ´ãÁõ¥Ê£íÔºâ
            gameState.riichiSticks += riichiPlayers.length;

            // Ê£ÄÊü•ÂØπÂ±ÄÊòØÂê¶ÁªìÊùü
            if (checkGameEnd(true, dealerTenpai)) {
                gameState.gameEnded = true;
            }

            // ÊµÅÂ±ÄÊó∂Êú¨Âú∫Êï∞ÊÄªÊòØ+1
            gameState.honba++;

            // Êõ¥Êñ∞Â∫ÑÂÆ∂ÂíåÂ±ÄÊï∞
            if (dealerTenpai) {
                // Â∫ÑÂÆ∂Âê¨ÁâåÔºåËøûÂ∫ÑÔºöÂ±ÄÊï∞‰∏çÂèò
            } else {
                // Â∫ÑÂÆ∂Êú™Âê¨ÁâåÔºåËΩÆÂ∫ÑÔºöÂ∫ÑÂÆ∂ËΩÆÊç¢ÔºåÂ±ÄÊï∞+1
                gameState.dealer = (gameState.dealer + 1) % 4;
                gameState.round++;
            }

            // Ê∏ÖÈô§Â§çÈÄâÊ°Ü
            for (let i = 0; i < 4; i++) {
                document.getElementById(`tenpai-${i}`).checked = false;
                document.getElementById(`ryuukyoku-riichi-${i}`).checked = false;
            }

            saveState();
            updateDisplay();

            if (gameState.gameEnded) {
                showMessage(t('msg_ryuukyoku_success_end'), 'success', 'ryuukyoku-message');
            } else {
                showMessage(t('msg_ryuukyoku_success'), 'success', 'ryuukyoku-message');
            }
        }

        // Êí§ÈîÄ‰∏ä‰∏ÄÂ±Ä
        function undoLast() {
            if (gameState.history.length === 0) {
                showMessage(t('msg_no_history'), 'error');
                return;
            }

            const lastRecord = gameState.history.pop();
            gameState.scores = lastRecord.scoreBefore;
            gameState.round = lastRecord.roundBefore;
            gameState.dealer = lastRecord.dealerBefore;
            gameState.honba = lastRecord.honbaBefore;
            gameState.riichiSticks = lastRecord.riichiSticksBefore;
            gameState.gameEnded = false; // Êí§ÈîÄÂêéÂØπÂ±ÄÁªßÁª≠

            saveState();
            updateDisplay();
            showMessage(t('msg_undo_success'), 'success');
        }

        // Ê∏ÖÁ©∫ÂéÜÂè≤
        function clearHistory() {
            if (!confirm(t('msg_clear_confirm'))) return;

            const initialScore = getInitialScore(gameState.rule);
            gameState.scores = [initialScore, initialScore, initialScore, initialScore];
            gameState.history = [];
            gameState.round = 0;
            gameState.dealer = 0;
            gameState.honba = 0;
            gameState.riichiSticks = 0;
            gameState.gameEnded = false;

            saveState();
            updateDisplay();
            showMessage(t('msg_history_cleared'), 'success');
        }

        // Ëé∑ÂèñÂ±ÄÊï∞ÊòæÁ§∫ÊñáÊú¨
        function getRoundText(round, honba) {
            const roundNames = t('round_names');
            const roundIndex = Math.floor(round / 4);
            const subRound = (round % 4) + 1;
            let roundName;
            if (LANGUAGE === 'en') {
                roundName = `${roundNames[roundIndex % 4]} ${subRound}`;
            } else {
                roundName = `${roundNames[roundIndex % 4]}${subRound}${t('round_suffix')}`;
            }
            if (honba > 0) {
                if (LANGUAGE === 'en') {
                    return `${roundName} ¬∑ ${honba}${t('honba_suffix')}`;
                }
                return `${roundName}${honba}${t('honba_suffix')}`;
            }
            return roundName;
        }

        function formatScoreDelta(before, after) {
            const delta = after - before;
            const formattedDelta = delta > 0 ? `+${delta.toLocaleString()}` : delta.toLocaleString();
            return `${before.toLocaleString()} ‚Üí ${after.toLocaleString()} (${formattedDelta})`;
        }

        function renderScoreChanges(record, players) {
            if (!record.scoreBefore || !record.scoreAfter) return '';
            const rows = record.scoreBefore.map((score, i) => {
                const after = record.scoreAfter[i];
                const delta = after - score;
                const color = delta > 0 ? '#28a745' : (delta < 0 ? '#dc3545' : '#666');
                const playerName = players[i] || getDefaultPlayerName(i);
                return `<div style="display: flex; justify-content: space-between; gap: 12px;">
                    <span>${playerName}</span>
                    <span style="color: ${color}; font-weight: 600;">${formatScoreDelta(score, after)}</span>
                </div>`;
            }).join('');
            return `<div style="padding: 8px 12px; background: rgba(102, 126, 234, 0.08); border-radius: 6px; min-width: 210px;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #667eea;">${t('history_score_changes')}</div>
                ${rows}
            </div>`;
        }

        // Êõ¥Êñ∞ÂéÜÂè≤ÊòæÁ§∫
        function updateHistory() {
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';

            if (gameState.history.length === 0) {
                historyDiv.innerHTML = `<p style="text-align: center; color: #999;">${t('history_empty')}</p>`;
                return;
            }

            gameState.history.slice().reverse().forEach((record, index) => {
                const actualIndex = gameState.history.length - 1 - index;

                // Ëé∑ÂèñÂ±ÄÊï∞ÂíåÊú¨Âú∫Êï∞
                const roundText = getRoundText(record.roundBefore, record.honbaBefore);
                const playersSnapshot = record.scoreBefore
                    ? record.scoreBefore.map((_, idx) => gameState.players[idx] || getDefaultPlayerName(idx))
                    : [];

                let detailsHtml = '';

                if (record.type === 'ryuukyoku') {
                    // ÊµÅÂ±ÄËÆ∞ÂΩï
                    const nameSeparator = LANGUAGE === 'en' ? ', ' : '„ÄÅ';
                    const tenpaiNames = (record.tenpaiPlayers || []).map(id =>
                        gameState.players[id] || getDefaultPlayerName(id)
                    ).join(nameSeparator);
                    let tenpaiText;
                    if (record.tenpaiPlayers.length === 0) {
                        tenpaiText = t('history_all_noten');
                    } else if (record.tenpaiPlayers.length === 4) {
                        tenpaiText = t('history_all_tenpai');
                    } else {
                        tenpaiText = `${t('history_tenpai_prefix')}${tenpaiNames}`;
                    }

                    let riichiText = '';
                    if (record.riichiPlayers && record.riichiPlayers.length > 0) {
                        const riichiNames = record.riichiPlayers.map(id => gameState.players[id] || getDefaultPlayerName(id)).join(nameSeparator);
                        riichiText = `<br>${t('riichi_players_label')}: ${riichiNames}`;
                    }

                    const dealerStatus = record.dealerTenpai ? t('history_continue') : t('history_change');
                    const scoreChanges = renderScoreChanges(record, playersSnapshot);

                    detailsHtml = `
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 5px; display:flex; gap:12px; align-items:flex-start; flex-wrap: wrap;">
                            <div style="min-width:200px;">
                                ${roundText}
                                <br>
                                <strong>${t('history_ryuukyoku')}</strong> (${dealerStatus})
                                <br>
                                ${tenpaiText}${riichiText}
                            </div>
                            ${scoreChanges}
                        </div>
                    `;
                } else {
                    // ÂíåÁâåËÆ∞ÂΩï
                    const winnerName = gameState.players[record.winnerId] || getDefaultPlayerName(record.winnerId);
                    const loserName = record.isTsumo
                        ? t('tsumo_text')
                        : (gameState.players[record.loserId] || getDefaultPlayerName(record.loserId));
                    let pointsStr;
                    if (record.isTsumo) {
                        pointsStr = record.points.join('/');
                    } else {
                        pointsStr = `${t('ron_text')} ${record.points}${LANGUAGE === 'en' ? ' pts' : 'ÁÇπ'}`;
                    }

                    // ÊòæÁ§∫ÂΩπÁßç„ÄÅÈó®Ê∏ÖÁä∂ÊÄÅ‰ª•ÂèäÂÆùÁâå‰ø°ÊÅØ
                    const yakuSegments = [];
                    if (record.yaku) {
                        const menzenStatus = record.isMenzen === false ? (LANGUAGE === 'en' ? 'Open ' : 'ÂâØÈú≤ ') : '';
                        yakuSegments.push(`${menzenStatus}${record.yaku}`);
                    }
                    const doraSegments = [];
                    if (record.doraCount) doraSegments.push(LANGUAGE === 'en'
                        ? `Dora ${record.doraCount}${t('han_unit')}`
                        : `ÂÆùÁâå${record.doraCount}Áï™`);
                    if (record.akaDoraCount) doraSegments.push(LANGUAGE === 'en'
                        ? `Red ${record.akaDoraCount}${t('han_unit')}`
                        : `Ëµ§${record.akaDoraCount}Áï™`);
                    if (record.uraDoraCount) doraSegments.push(LANGUAGE === 'en'
                        ? `Ura ${record.uraDoraCount}${t('han_unit')}`
                        : `Èáå${record.uraDoraCount}Áï™`);
                    if (doraSegments.length > 0) {
                        yakuSegments.push(doraSegments.join(' + '));
                    }
                    const yakuText = yakuSegments.length > 0
                        ? `<br><small style="color: #28a745;">${t('yaku_label')}: ${yakuSegments.join(' ¬∑ ')}</small>`
                        : '';

                    const extraInfo = [];
                    if (record.honbaPoints > 0) extraInfo.push(t('extra_honba', { points: record.honbaPoints }));
                    if (record.riichiPoints > 0) extraInfo.push(t('extra_riichi', { points: record.riichiPoints }));
                    if (record.riichiPlayers && record.riichiPlayers.length > 0) {
                        const riichiNames = record.riichiPlayers.map(id => gameState.players[id] || getDefaultPlayerName(id)).join(nameSeparator);
                        extraInfo.push(`${t('riichi_players_label')}: ${riichiNames}`);
                    }
                    const extraText = extraInfo.length > 0 ? `<br><small>${extraInfo.join(t('history_extra_separator'))}</small>` : '';

                    const dealerSuffix = record.isDealer ? t('history_dealer_suffix') : '';
                    const summaryText = t('history_winner_summary', {
                        winner: winnerName,
                        han: record.han,
                        fu: record.fu,
                        dealer: dealerSuffix
                    });
                    const loserSummary = record.isTsumo
                        ? t('history_tsumo_summary', { points: pointsStr })
                        : t('history_loser_summary', { loser: loserName, points: pointsStr });

                    const scoreChanges = renderScoreChanges(record, playersSnapshot);

                    detailsHtml = `
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 5px; display:flex; gap:12px; align-items:flex-start; flex-wrap: wrap;">
                            <div style="min-width:200px;">
                                ${roundText}
                                <br>
                                <strong>${summaryText}</strong>
                                ${yakuText}
                                <br>
                                ${loserSummary}${extraText}
                            </div>
                            ${scoreChanges}
                        </div>
                    `;
                }

                // Âè™ÊúâÊúÄÊñ∞ÁöÑ‰∏ÄÊù°ËÆ∞ÂΩï(index === 0)ÊâçÊòæÁ§∫Êí§ÈîÄÊåâÈíÆ
                const undoButton = index === 0
                    ? `<button onclick="undoLast()">${t('undo_button')}</button>`
                    : '';

                historyDiv.innerHTML += `
                    <div class="history-item">
                        <div class="details">
                            ${detailsHtml}
                        </div>
                        ${undoButton}
                    </div>
                `;
            });
        }

        function setCopyStatus(message, isError = false) {
            const statusEl = document.getElementById('copy-status');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#dc3545' : '#28a745';
            if (copyStatusTimeout) {
                clearTimeout(copyStatusTimeout);
            }
            copyStatusTimeout = setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        }

        async function copyTextToClipboard(text) {
            if (!text) {
                setCopyStatus(t('copy_none'), true);
                return false;
            }
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    if (!successful) {
                        throw new Error(t('copy_exec_failed'));
                    }
                }
                return true;
            } catch (err) {
                console.error('Clipboard copy failed', err);
                setCopyStatus(t('copy_failed') + err.message, true);
                return false;
            }
        }

        async function copyGameSummary(auto = false) {
            const summaryElement = document.getElementById('game-summary-json');
            if (!summaryElement) return;
            const text = summaryElement.textContent.trim();
            if (!text) {
                if (!auto) setCopyStatus(t('copy_none'), true);
                return;
            }
            if (auto && text === lastCopiedSummary) {
                return;
            }
            const ok = await copyTextToClipboard(text);
            if (ok) {
                lastCopiedSummary = text;
                setCopyStatus(auto ? t('copy_auto') : t('copy_success'));
            }
        }

        function generateGameSummary() {
            const players = gameState.players.map((name, i) => name || getDefaultPlayerName(i));
            const initialScore = getInitialScore(gameState.rule);
            const rounds = gameState.history.map((record, index) => {
                const roundNumber = record.roundBefore !== undefined ? record.roundBefore : gameState.round;
                const honbaBefore = record.honbaBefore !== undefined ? record.honbaBefore : 0;
                const riichiSticksBefore = record.riichiSticksBefore !== undefined ? record.riichiSticksBefore : 0;
                const dealerIndex = record.dealerBefore !== undefined ? record.dealerBefore : gameState.dealer;
                const roundName = getRoundText(roundNumber, honbaBefore);
                const riichiPlayers = (record.riichiPlayers || []).map(id => players[id]);
                const scoreBeforeArr = record.scoreBefore || gameState.scores;
                const scoreAfterArr = record.scoreAfter || scoreBeforeArr;
                const base = {
                    index: index + 1,
                    type: record.type,
                    round: {
                        number: roundNumber,
                        name: roundName,
                        honba: honbaBefore,
                        riichiSticks: riichiSticksBefore,
                        dealer: players[dealerIndex]
                    },
                    scores: scoreBeforeArr.map((before, i) => {
                        const after = scoreAfterArr[i] !== undefined ? scoreAfterArr[i] : before;
                        return {
                            player: players[i],
                            before,
                            after,
                            delta: after - before
                        };
                    })
                };

                if (record.type === 'win') {
                    const yakuList = record.yaku ? record.yaku.split(/\s+/).filter(Boolean) : [];
                    const loserNameText = record.isTsumo
                        ? 'Ëá™Êë∏'
                        : (players[record.loserId] || getDefaultPlayerName(record.loserId || 0));
                    base.result = {
                        winner: players[record.winnerId],
                        loser: loserNameText,
                        isTsumo: record.isTsumo,
                        isDealer: record.isDealer,
                        isMenzen: record.isMenzen !== false,
                        han: record.han,
                        fu: record.fu,
                        yaku: yakuList,
                        yakuHan: record.yakuHan,
                        dora: {
                            dora: record.doraCount,
                            aka: record.akaDoraCount,
                            ura: record.uraDoraCount
                        },
                        points: record.isTsumo
                            ? { type: 'tsumo', payments: record.points }
                            : { type: 'ron', payment: record.points },
                        honbaBonus: record.honbaPoints,
                        riichiBonus: record.riichiPoints,
                        riichiPlayers
                    };
                    base.result.note = record.isTsumo ? t('summary_note_tsumo') : t('summary_note_ron');
                } else {
                    const tenpaiPlayers = (record.tenpaiPlayers || []).map(id => players[id]);
                    base.result = {
                        tenpaiPlayers,
                        riichiPlayers,
                        dealerTenpai: record.dealerTenpai
                    };
                }

                const riichiAfter = record.type === 'win'
                    ? 0
                    : riichiSticksBefore + (record.riichiPlayers ? record.riichiPlayers.length : 0);
                base.round.riichiSticksAfter = riichiAfter;
                base.round.honbaAfter = record.type === 'win'
                    ? ((record.isDealer ? honbaBefore + 1 : 0))
                    : honbaBefore + 1;

                return base;
            });

            const summary = {
                rule: gameState.rule,
                players,
                initialScore,
                gameEnded: gameState.gameEnded,
                currentRound: getRoundText(gameState.round, gameState.honba),
                dealer: players[gameState.dealer],
                honba: gameState.honba,
                riichiSticks: gameState.riichiSticks,
                scores: gameState.scores.map((score, i) => ({
                    player: players[i],
                    score
                })),
                rounds
            };

            if (gameState.gameEnded && gameState.history.length > 0) {
                summary.finalResults = calculateFinalResults().map(result => ({
                    playerIndex: result.index,
                    rank: result.rank,
                    player: result.name,
                    finalScore: result.finalScore,
                    rawScore: result.rawScore,
                    uma: result.uma,
                    riichiBonus: result.riichiBonus,
                    totalScore: result.totalScore
                }));
            }

            return summary;
        }

        function updateGameSummary() {
            const summaryElement = document.getElementById('game-summary-json');
            if (!summaryElement) return;
            try {
                const summary = generateGameSummary();
                summaryElement.textContent = JSON.stringify(summary, null, 2);
                if (gameState.history.length > 0) {
                    copyGameSummary(true);
                }
            } catch (error) {
                console.error('Failed to generate game summary', error);
                summaryElement.textContent = `// Êó†Ê≥ïÁîüÊàêÂØπÂ±ÄÊëòË¶Å: ${error.message}`;
            }
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(msg, type, targetId = 'message') {
            const messageDiv = document.getElementById(targetId);
            messageDiv.className = type;
            messageDiv.textContent = msg;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // ‰øùÂ≠òÁä∂ÊÄÅ
        function saveState() {
            localStorage.setItem('mahjongGameState', JSON.stringify(gameState));
        }

        // Âä†ËΩΩÁä∂ÊÄÅ
        function loadState() {
            const saved = localStorage.getItem('mahjongGameState');
            if (saved) {
                gameState = JSON.parse(saved);

                // ÂêëÂêéÂÖºÂÆπÔºö‰∏∫ÊóßËÆ∞ÂΩïÊ∑ªÂä†typeÂ≠óÊÆµ
                if (gameState.history) {
                    gameState.history.forEach(record => {
                        if (!record.type) {
                            record.type = 'win';
                        }
                        if (record.doraCount === undefined) record.doraCount = 0;
                        if (record.akaDoraCount === undefined) record.akaDoraCount = 0;
                        if (record.uraDoraCount === undefined) record.uraDoraCount = 0;
                        if (record.yakuHan === undefined && record.han !== undefined) {
                            record.yakuHan = Math.max(
                                record.han - record.doraCount - record.akaDoraCount - record.uraDoraCount,
                                0
                            );
                        }
                    });
                }

                // Á°Æ‰øùhonbaÂíåriichiSticksÂ≠òÂú®
                if (gameState.honba === undefined) gameState.honba = 0;
                if (gameState.riichiSticks === undefined) gameState.riichiSticks = 0;
                if (gameState.gameEnded === undefined) gameState.gameEnded = false;

                // ÊÅ¢Â§çËßÑÂàôÈÄâÊã©
                document.querySelectorAll('.rule-btn-compact').forEach(btn => {
                    if (btn.dataset.rule === gameState.rule) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
