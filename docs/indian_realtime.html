<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…çº§ç¿»å€ï¼å°ç¬¬å®‰éº»å°† - å®æ—¶å¤šäºº</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .game-hash {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .player-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .player-card.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .player-card.me {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .card {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1em;
            display: inline-block;
        }

        .card-hidden {
            background: #6c757d;
        }

        .cards-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .player-card-display {
            flex: 1;
            min-width: 150px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
            text-align: center;
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .score-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
        }

        .score-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .field-pot {
            background: #ffc107;
            border: 2px solid #ff9800;
        }

        .field-pot h3 {
            color: #856404;
        }

        .info-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .scores-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ´ è¶…çº§ç¿»å€ï¼å°ç¬¬å®‰éº»å°†</h1>
        <div class="game-hash" id="game-hash"></div>

        <!-- é˜¶æ®µ1: è¾“å…¥å§“å -->
        <div class="section" id="name-section">
            <h2>1. è¾“å…¥ä½ çš„å§“å</h2>
            <div class="input-group">
                <input type="text" id="player-name-input" placeholder="è¾“å…¥ä½ çš„å§“å" maxlength="20">
                <button onclick="joinGame()">ç¡®å®š</button>
            </div>
            <div id="name-message"></div>
        </div>

        <!-- é˜¶æ®µ2: ç­‰å¾…ç©å®¶å’Œé€‰æ‹©è§’è‰² -->
        <div class="section hidden" id="players-section">
            <h2>2. ç­‰å¾…ç©å®¶ (<span id="player-count">0</span>/4)</h2>
            <div class="players-grid" id="players-grid"></div>
            <div style="margin-top: 20px;">
                <button onclick="showRoleSelection()" id="select-role-btn">é€‰æ‹©æˆ‘çš„è§’è‰²</button>
            </div>
        </div>

        <!-- è§’è‰²é€‰æ‹©é¢æ¿ -->
        <div class="section hidden" id="role-section">
            <h2>é€‰æ‹©ä½ çš„è§’è‰²</h2>
            <div class="info-message">è¯·é€‰æ‹©ä½ åœ¨æ¸¸æˆä¸­çš„ä½ç½®</div>
            <div class="players-grid">
                <div class="player-card" onclick="selectRole(0)" id="role-0">
                    <h3>ä¸œå®¶</h3>
                    <p id="role-0-status">å¯é€‰æ‹©</p>
                </div>
                <div class="player-card" onclick="selectRole(1)" id="role-1">
                    <h3>å—å®¶</h3>
                    <p id="role-1-status">å¯é€‰æ‹©</p>
                </div>
                <div class="player-card" onclick="selectRole(2)" id="role-2">
                    <h3>è¥¿å®¶</h3>
                    <p id="role-2-status">å¯é€‰æ‹©</p>
                </div>
                <div class="player-card" onclick="selectRole(3)" id="role-3">
                    <h3>åŒ—å®¶</h3>
                    <p id="role-3-status">å¯é€‰æ‹©</p>
                </div>
            </div>
        </div>

        <!-- é˜¶æ®µ3: é€‰æ‹©å±€æ•° -->
        <div class="section hidden" id="round-section">
            <h2>3. é€‰æ‹©å±€æ•°å¼€å§‹æ¸¸æˆ</h2>
            <div class="success-message">æ‰€æœ‰ç©å®¶å·²å‡†å¤‡å®Œæ¯•ï¼è¯·é€‰æ‹©è¦å¼€å§‹çš„å±€æ•°ã€‚</div>
            <select id="round-select">
                <option value="ä¸œ1å±€">ä¸œ1å±€</option>
                <option value="ä¸œ2å±€">ä¸œ2å±€</option>
                <option value="ä¸œ3å±€">ä¸œ3å±€</option>
                <option value="ä¸œ4å±€">ä¸œ4å±€</option>
                <option value="å—1å±€">å—1å±€</option>
                <option value="å—2å±€">å—2å±€</option>
                <option value="å—3å±€">å—3å±€</option>
                <option value="å—4å±€">å—4å±€</option>
            </select>
            <button onclick="startRound()" style="width: 100%; margin-top: 15px;">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- é˜¶æ®µ4: æ¸¸æˆè¿›è¡Œä¸­ - æ˜¾ç¤ºå¡ç‰‡ -->
        <div class="section hidden" id="cards-section">
            <h2>4. ç©å®¶NGå¡ç‰‡ - <span id="current-round"></span></h2>
            <div class="info-message">ä½ å¯ä»¥çœ‹åˆ°å…¶ä»–ç©å®¶çš„NGå¡ç‰‡ï¼Œä½†çœ‹ä¸åˆ°è‡ªå·±çš„å¡ç‰‡</div>
            <div class="cards-row" id="cards-row"></div>
        </div>

        <!-- é˜¶æ®µ5: ç‚¹æ•°è¿½è¸ª -->
        <div class="section hidden" id="scores-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">5. ç‚¹æ•°è¿½è¸ª</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-weight: 600; color: #666;">åœºä¾›ï¼š</span>
                    <span id="field-pot-display" style="font-size: 1.3em; font-weight: bold; color: #007bff;">0</span>
                    <input type="number"
                           class="adjustment-input"
                           style="width: 120px; padding: 5px; border: 2px solid #ddd; border-radius: 5px;"
                           id="adj-field"
                           placeholder="åœºä¾›å˜åŠ¨ï¼ˆÂ±ï¼‰"
                           oninput="updateAdjustmentSum()">
                </div>
            </div>
            <div class="scores-grid" id="scores-grid"></div>
            <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">åº”ç”¨ç‚¹æ•°å˜åŠ¨</h3>
                <p style="color: #666; margin-bottom: 15px;">è¾“å…¥æ¯ä¸ªç©å®¶çš„æ”¶æ”¯ï¼ˆæ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ”¯å‡ºï¼‰ï¼Œæ”¶æ”¯æ€»å’Œå¿…é¡»ä¸º0æ‰èƒ½åº”ç”¨</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <span style="font-weight: 600;">å½“å‰æ”¶æ”¯æ€»å’Œï¼š</span>
                    <span id="adjustment-sum" style="font-weight: bold; color: #dc3545;">0</span>
                </div>
                <button id="apply-btn" onclick="applyAdjustments()" disabled>åº”ç”¨å˜åŠ¨</button>
                <div id="adjustment-message"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = null;
        let myRoleIndex = null;
        const roleNames = ['ä¸œå®¶', 'å—å®¶', 'è¥¿å®¶', 'åŒ—å®¶'];
        let game_state = { players: [] };  // æœ¬åœ°æ¸¸æˆçŠ¶æ€ç¼“å­˜

        // è¿æ¥æˆåŠŸ
        socket.on('connect', () => {
            console.log('è¿æ¥åˆ°æœåŠ¡å™¨');
        });

        // æ¥æ”¶æ¸¸æˆçŠ¶æ€æ›´æ–°
        socket.on('game_state_update', (data) => {
            console.log('æ¸¸æˆçŠ¶æ€æ›´æ–°:', data);
            game_state.players = data.players;
            updatePlayersDisplay(data.players);
            if (data.game_started) {
                updateScoresDisplay(data.scores, data.field_pot);
            }
        });

        // æ¥æ”¶ç©å®¶åˆ—è¡¨æ›´æ–°
        socket.on('players_update', (data) => {
            console.log('ç©å®¶åˆ—è¡¨æ›´æ–°:', data);
            game_state.players = data.players;
            updatePlayersDisplay(data.players);
            updateRoleSelection(data.players);
        });

        // å‡†å¤‡å¼€å§‹æ¸¸æˆ
        socket.on('ready_to_start', (data) => {
            console.log('å‡†å¤‡å¼€å§‹:', data);
            document.getElementById('round-section').classList.remove('hidden');
        });

        // æ¸¸æˆå¼€å§‹
        socket.on('game_started', (data) => {
            console.log('æ¸¸æˆå¼€å§‹:', data);
            document.getElementById('current-round').textContent = data.round;
            document.getElementById('game-hash').textContent = `æ¸¸æˆID: ${data.game_hash}`;
            renderCards(data.players, data.cards);
            updateScoresDisplay(data.scores, data.field_pot);
            document.getElementById('cards-section').classList.remove('hidden');
            document.getElementById('scores-section').classList.remove('hidden');
            // ä¸éšè—å±€æ•°é€‰æ‹©ï¼Œå…è®¸åˆ‡æ¢å±€æ•°
            document.getElementById('round-select').value = data.round;
            // æ¸¸æˆå¼€å§‹åéšè—è§’è‰²é€‰æ‹©æŒ‰é’®å’Œè§’è‰²é€‰æ‹©é¢æ¿
            document.getElementById('select-role-btn').style.display = 'none';
            document.getElementById('role-section').classList.add('hidden');
        });

        // åˆ†æ•°æ›´æ–°
        socket.on('scores_update', (data) => {
            console.log('åˆ†æ•°æ›´æ–°:', data);
            updateScoresDisplay(data.scores, data.field_pot);
        });

        // é”™è¯¯æ¶ˆæ¯
        socket.on('error', (data) => {
            showMessage('name-message', data.message, 'error');
        });

        // åŠ å…¥æ¸¸æˆ
        function joinGame() {
            const nameInput = document.getElementById('player-name-input');
            const name = nameInput.value.trim();

            if (!name) {
                showMessage('name-message', 'è¯·è¾“å…¥å§“å', 'error');
                return;
            }

            myName = name;
            socket.emit('join_game', { name: name });

            // éšè—è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºç©å®¶åˆ—è¡¨
            document.getElementById('name-section').classList.add('hidden');
            document.getElementById('players-section').classList.remove('hidden');
        }

        // æ˜¾ç¤ºè§’è‰²é€‰æ‹©
        function showRoleSelection() {
            document.getElementById('role-section').classList.remove('hidden');
        }

        // é€‰æ‹©è§’è‰²
        function selectRole(roleIndex) {
            socket.emit('select_role', { role_index: roleIndex });
            myRoleIndex = roleIndex;
            document.getElementById('role-section').classList.add('hidden');
        }

        // å¼€å§‹å±€
        function startRound() {
            const round = document.getElementById('round-select').value;
            socket.emit('start_round', { round: round });
        }

        // æ›´æ–°ç©å®¶æ˜¾ç¤º
        function updatePlayersDisplay(players) {
            const grid = document.getElementById('players-grid');
            const count = document.getElementById('player-count');
            count.textContent = players.length;

            grid.innerHTML = '';
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                if (player.name === myName) {
                    card.classList.add('me');
                }
                if (player.role_index !== null) {
                    card.classList.add('selected');
                }

                card.innerHTML = `
                    <h3>${player.name}</h3>
                    <p>${player.role_index !== null ? roleNames[player.role_index] : 'æœªé€‰æ‹©è§’è‰²'}</p>
                `;
                grid.appendChild(card);
            });
        }

        // æ›´æ–°è§’è‰²é€‰æ‹©æ˜¾ç¤º
        function updateRoleSelection(players) {
            for (let i = 0; i < 4; i++) {
                const player = players.find(p => p.role_index === i);
                const statusEl = document.getElementById(`role-${i}-status`);
                const roleCard = document.getElementById(`role-${i}`);

                if (player) {
                    statusEl.textContent = `å·²è¢« ${player.name} é€‰æ‹©`;
                    roleCard.style.opacity = '0.5';
                    roleCard.style.pointerEvents = 'none';
                } else {
                    statusEl.textContent = 'å¯é€‰æ‹©';
                    roleCard.style.opacity = '1';
                    roleCard.style.pointerEvents = 'auto';
                }
            }
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards(players, cards) {
            const cardsRow = document.getElementById('cards-row');
            cardsRow.innerHTML = '';

            // æŒ‰ç…§ role_index æ’åº
            const sortedPlayers = players.sort((a, b) => a.role_index - b.role_index);

            sortedPlayers.forEach((player, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'player-card-display';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'player-name';
                nameDiv.textContent = player.name;

                const cardSpan = document.createElement('span');
                if (player.name === myName) {
                    // è‡ªå·±çš„å¡ç‰‡éšè—
                    cardSpan.className = 'card card-hidden';
                    cardSpan.textContent = '???';
                } else {
                    // æ˜¾ç¤ºå…¶ä»–äººçš„å¡ç‰‡
                    cardSpan.className = 'card';
                    cardSpan.textContent = cards[index];
                }

                cardDiv.appendChild(nameDiv);
                cardDiv.appendChild(cardSpan);
                cardsRow.appendChild(cardDiv);
            });
        }

        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScoresDisplay(scores, fieldPot) {
            const grid = document.getElementById('scores-grid');
            grid.innerHTML = '';

            // æ›´æ–°åœºä¾›æ˜¾ç¤º
            document.getElementById('field-pot-display').textContent = fieldPot.toLocaleString();

            // è·å–è‡ªå·±çš„åº§ä½ç´¢å¼•ç”¨äºè®¡ç®—å·®å€¼
            const myRoleScore = myRoleIndex !== null ? scores[myRoleIndex] : null;

            // æ˜¾ç¤º4ä¸ªå›ºå®šåº§ä½çš„åˆ†æ•°å¡ç‰‡ï¼Œä½†ç”¨ç©å®¶åå­—æ˜¾ç¤º
            for (let roleIndex = 0; roleIndex < 4; roleIndex++) {
                const card = document.createElement('div');
                card.className = 'score-card';

                const score = scores[roleIndex] || 0;

                // æ‰¾åˆ°ååœ¨è¿™ä¸ªä½ç½®çš„ç©å®¶
                const playerAtRole = game_state.players.find(p => p.role_index === roleIndex);
                const playerName = playerAtRole ? playerAtRole.name : roleNames[roleIndex];
                const isMe = playerAtRole && playerAtRole.name === myName;

                let diffHTML = '';
                if (myRoleScore !== null && roleIndex !== myRoleIndex) {
                    const diff = score - myRoleScore;
                    const diffColor = diff > 0 ? '#28a745' : diff < 0 ? '#dc3545' : '#6c757d';
                    const diffSign = diff > 0 ? '+' : '';
                    diffHTML = `<span style="font-size: 0.7em; color: ${diffColor}; margin-left: 8px;">(${diffSign}${diff.toLocaleString()})</span>`;
                }

                card.innerHTML = `
                    <h3>${playerName}${isMe ? ' (ä½ )' : ''}</h3>
                    <div class="score-value">
                        ${score.toLocaleString()}${diffHTML}
                    </div>
                    <input type="number"
                           class="adjustment-input"
                           id="adj-${roleIndex}"
                           placeholder="æ”¶æ”¯ï¼ˆÂ±ï¼‰"
                           oninput="updateAdjustmentSum()">
                `;
                grid.appendChild(card);
            }
        }

        // æ›´æ–°æ”¶æ”¯æ€»å’Œ
        function updateAdjustmentSum() {
            const inputs = document.querySelectorAll('.adjustment-input');
            let sum = 0;

            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                sum += value;
            });

            document.getElementById('adjustment-sum').textContent = sum.toLocaleString();
            document.getElementById('apply-btn').disabled = sum !== 0;
        }

        // åº”ç”¨ç‚¹æ•°è°ƒæ•´
        function applyAdjustments() {
            const adjustments = {};
            const inputs = document.querySelectorAll('.adjustment-input');

            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                if (value !== 0) {
                    const id = input.id.replace('adj-', '');
                    adjustments[id === 'field' ? 'field_pot' : id] = value;
                }
            });

            socket.emit('update_scores', { adjustments: adjustments });

            // æ¸…ç©ºè¾“å…¥æ¡†
            inputs.forEach(input => input.value = '');
            updateAdjustmentSum();

            showMessage('adjustment-message', 'ç‚¹æ•°å˜åŠ¨å·²åº”ç”¨ï¼', 'success');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = type === 'error' ? 'error-message' : type === 'success' ? 'success-message' : 'info-message';
            element.textContent = message;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
