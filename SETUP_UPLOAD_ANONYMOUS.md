# åŒ¿åä¸Šä¼ åŠŸèƒ½è®¾ç½®æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•è®¾ç½®**æ— éœ€ç™»å½•**çš„ä¸Šä¼ åŠŸèƒ½ã€‚

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

âœ… **æ— éœ€ç™»å½•** - ä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥ä¸Šä¼ ç‰Œè°±
âœ… **å¯é€‰æ˜µç§°** - ä¸Šä¼ è€…å¯ä»¥é€‰æ‹©æ€§åœ°ç•™ä¸‹æ˜µç§°
âœ… **æ¯æ—¥é™é¢** - æ¯å¤©æœ€å¤šä¸Šä¼  50 ä¸ªæ–‡ä»¶ï¼Œé˜²æ­¢æ»¥ç”¨
âœ… **å®‰å…¨é™åˆ¶** - æ–‡ä»¶å¤§å°å’Œæ ¼å¼é™åˆ¶é˜²æ­¢æ»¥ç”¨
âœ… **è‡ªåŠ¨éªŒè¯** - Cloud Functions è‡ªåŠ¨éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§
âœ… **å®Œå…¨å…è´¹** - Firebase å…è´¹å¥—é¤å®Œå…¨å¤Ÿç”¨

## ğŸ”’ å®‰å…¨æœºåˆ¶

è™½ç„¶å…è®¸åŒ¿åä¸Šä¼ ï¼Œä½†æœ‰ä»¥ä¸‹å®‰å…¨æªæ–½ï¼š

### Storage è§„åˆ™é™åˆ¶ï¼š
- âœ… åªå…è®¸ JSON æ ¼å¼æ–‡ä»¶
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ 5 MB
- âœ… åªèƒ½ä¸Šä¼ åˆ° `game-logs/` ç›®å½•

### Firestore è§„åˆ™é™åˆ¶ï¼š
- âœ… æ¯å¤©æœ€å¤šä¸Šä¼  50 ä¸ªæ–‡ä»¶ï¼ˆUTC æ—¶åŒºï¼‰
- âœ… åªèƒ½åˆ›å»ºåŒ…å«å¿…éœ€å­—æ®µçš„æ–‡æ¡£
- âœ… ä¸å…è®¸æ™®é€šç”¨æˆ·ä¿®æ”¹æˆ–åˆ é™¤
- âœ… æ•°æ®ç±»å‹éªŒè¯

### Cloud Functions éªŒè¯ï¼š
- âœ… è‡ªåŠ¨éªŒè¯ JSON æ ¼å¼
- âœ… æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„éº»å°†ç‰Œè°±
- âœ… è®°å½•éªŒè¯å¤±è´¥çš„æ–‡ä»¶

## ğŸ“ ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·æ‰“å¼€ä¸Šä¼ é¡µé¢
    â†“
æ˜¾ç¤ºä»Šæ—¥å‰©ä½™é…é¢ï¼ˆæœ€å¤š50ä¸ªï¼‰
    â†“
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    â†“
ï¼ˆå¯é€‰ï¼‰è¾“å…¥æ˜µç§°
    â†“
æ£€æŸ¥é…é¢æ˜¯å¦è¶³å¤Ÿ
    â†“
Firebase Storageï¼ˆå­˜å‚¨æ–‡ä»¶ï¼‰
    â†“
Firestoreï¼ˆä¿å­˜å…ƒæ•°æ® + é€’å¢è®¡æ•°å™¨ï¼‰
    â†“
Cloud Functionsï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
    â†“
æ ‡è®°ä¸ºå¾…å¤„ç†
    â†“
æ›´æ–°é…é¢æ˜¾ç¤º
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. åˆ›å»º Firebase é¡¹ç›®

è®¿é—® https://console.firebase.google.com/

1. åˆ›å»ºæ–°é¡¹ç›®
2. **ä¸éœ€è¦**å¯ç”¨ Authentication
3. å¯ç”¨ Firestore Databaseï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
4. å¯ç”¨ Storage

### 2. é…ç½® Web åº”ç”¨

1. Firebase Console â†’ é¡¹ç›®è®¾ç½® â†’ æ·»åŠ åº”ç”¨ â†’ Web
2. å¤åˆ¶é…ç½®åˆ° `docs/upload.html` ç¬¬ 346 è¡Œ
3. æ›´æ–° `.firebaserc` ä¸­çš„é¡¹ç›® ID

### 3. éƒ¨ç½²

```bash
# å®‰è£…ä¾èµ–
cd functions && npm install && cd ..

# éƒ¨ç½²
firebase login
firebase deploy
```

å®Œæˆï¼è®¿é—® `https://ä½ çš„é¡¹ç›®ID.web.app/upload.html` æµ‹è¯•ä¸Šä¼ ã€‚

## ğŸ›¡ï¸ é˜²æ»¥ç”¨å»ºè®®

### åŸºç¡€é˜²æŠ¤ï¼ˆå·²å®ç°ï¼‰
- âœ… **æ¯æ—¥ä¸Šä¼ é™é¢** - æ¯å¤©æœ€å¤š 50 ä¸ªæ–‡ä»¶
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ - å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 5 MB
- âœ… æ–‡ä»¶ç±»å‹é™åˆ¶ - åªå…è®¸ JSON æ ¼å¼
- âœ… æ ¼å¼éªŒè¯ - Cloud Functions è‡ªåŠ¨éªŒè¯æ–‡ä»¶æ ¼å¼

### æ¯æ—¥é™é¢å·¥ä½œåŸç†

**å®ç°æ–¹å¼ï¼š**
1. Firestore ä¸­çš„ `upload-counters` é›†åˆè®°å½•æ¯å¤©çš„ä¸Šä¼ æ•°é‡
2. æ¯æ¬¡åˆ›å»º `game-logs` æ–‡æ¡£æ—¶ï¼ŒFirestore è§„åˆ™æ£€æŸ¥ä»Šæ—¥è®¡æ•°å™¨
3. Cloud Functions è§¦å‘å™¨è‡ªåŠ¨é€’å¢è®¡æ•°å™¨ï¼ˆåŸå­æ“ä½œï¼‰
4. ä¸Šä¼ é¡µé¢å®æ—¶æ˜¾ç¤ºå‰©ä½™é…é¢

**ç‰¹ç‚¹ï¼š**
- âœ… æœåŠ¡å™¨ç«¯å¼ºåˆ¶æ‰§è¡Œï¼ˆæ— æ³•ç»•è¿‡ï¼‰
- âœ… ä½¿ç”¨ Firestore äº‹åŠ¡ç¡®ä¿åŸå­æ€§
- âœ… å‰ç«¯å®æ—¶æ˜¾ç¤ºå‰©ä½™é…é¢
- âœ… é…é¢ç”¨å°½æ—¶è‡ªåŠ¨ç¦ç”¨ä¸Šä¼ æŒ‰é’®
- âœ… æ¯å¤© UTC 00:00 è‡ªåŠ¨é‡ç½®

### è¿›é˜¶é˜²æŠ¤ï¼ˆå¯é€‰ï¼Œå·²æœ‰æ¯æ—¥é™é¢çš„æƒ…å†µä¸‹é€šå¸¸ä¸éœ€è¦ï¼‰

#### 1. Firebase App Checkï¼ˆæ¨èï¼‰

é™åˆ¶åªæœ‰é€šè¿‡ä½ çš„ç½‘ç«™æ‰èƒ½ä¸Šä¼ ï¼Œé˜²æ­¢ç›´æ¥ API è°ƒç”¨ã€‚

**é…ç½®æ­¥éª¤ï¼š**

1. Firebase Console â†’ App Check
2. æ³¨å†Œ reCAPTCHA v3 å¯†é’¥
3. åœ¨ `upload.html` ä¸­æ·»åŠ ï¼š

```javascript
import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';

const appCheck = initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('YOUR_RECAPTCHA_SITE_KEY'),
  isTokenAutoRefreshEnabled: true
});
```

#### 2. æ›´ä¸¥æ ¼çš„é¢‘ç‡é™åˆ¶

å¦‚æœæ¯æ—¥ 50 ä¸ªæ–‡ä»¶çš„é™åˆ¶è¿˜ä¸å¤Ÿï¼Œå¯ä»¥æ·»åŠ æ›´ç»†ç²’åº¦çš„é¢‘ç‡é™åˆ¶ï¼š

**é€‰é¡¹ Aï¼šæ¯å°æ—¶é™åˆ¶**
- ä¿®æ”¹ Cloud Functionsï¼Œå¢åŠ æ¯å°æ—¶è®¡æ•°å™¨
- ä¾‹å¦‚ï¼šæ¯å°æ—¶æœ€å¤š 10 ä¸ªæ–‡ä»¶

**é€‰é¡¹ Bï¼šå•ç”¨æˆ·é™åˆ¶**
- ä½¿ç”¨æµè§ˆå™¨ localStorage æˆ– Cookie è·Ÿè¸ª
- æ³¨æ„ï¼šç”¨æˆ·å¯ä»¥æ¸…é™¤æµè§ˆå™¨æ•°æ®ç»•è¿‡

#### 3. ç®¡ç†å‘˜å®¡æ ¸

åœ¨ Firebase Console ä¸­æ·»åŠ å®¡æ ¸æµç¨‹ï¼š

1. æŸ¥çœ‹ Firestore çš„ `game-logs` é›†åˆ
2. æ£€æŸ¥å¯ç–‘ä¸Šä¼ 
3. æ‰‹åŠ¨åˆ é™¤æ¶æ„æ–‡ä»¶

#### 4. å†…å®¹è¿‡æ»¤

åœ¨ Cloud Functions ä¸­æ·»åŠ é¢å¤–éªŒè¯ï¼š

```javascript
// æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«æ•æ„Ÿè¯
if (fileName.includes('test') || fileName.includes('spam')) {
  console.log('Suspicious file name:', fileName);
  return null;
}

// æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦å¼‚å¸¸
if (jsonData.log.length > 100) {
  console.log('Unusually long game log:', jsonData.log.length);
  return null;
}
```

## ğŸ“Š ç›‘æ§ä¸Šä¼ 

### æŸ¥çœ‹ä¸Šä¼ æ–‡ä»¶

**Firebase Console â†’ Storage:**
- æµè§ˆ `game-logs/` ç›®å½•
- æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨å’Œå¤§å°

**Firebase Console â†’ Firestore:**
- æ‰“å¼€ `game-logs` é›†åˆ
- æŸ¥çœ‹ä¸Šä¼ å…ƒæ•°æ®

### è·å–ç»Ÿè®¡ä¿¡æ¯

è®¿é—® Cloud Function APIï¼š

```
https://your-region-your-project.cloudfunctions.net/getUploadStats
```

è¿”å›ï¼š
```json
{
  "total": 50,
  "processed": 30,
  "pending": 20,
  "failed": 0,
  "byLeague": {
    "m-league": 30,
    "ema": 10,
    "sanma": 10
  }
}
```

### æŸ¥çœ‹æ—¥å¿—

```bash
firebase functions:log
```

æˆ–åœ¨ Firebase Console â†’ Functions â†’ é€‰æ‹©å‡½æ•° â†’ Logs

## ğŸ”„ å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶

ä¸Šä¼ çš„æ–‡ä»¶å­˜å‚¨åœ¨ Firebase Storage ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨æˆ–è‡ªåŠ¨å¤„ç†ã€‚

### æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨å¤„ç†

1. Firebase Console â†’ Storage â†’ `game-logs/`
2. ä¸‹è½½æ–°æ–‡ä»¶
3. æ”¾åˆ°æœ¬åœ° `game-logs` ç›®å½•
4. è¿è¡Œ `python src/generate_website.py`
5. è¿è¡Œ `firebase deploy --only hosting`

### æ–¹æ¡ˆ Bï¼šå®šæœŸæ‰¹é‡å¤„ç†

åˆ›å»ºä¸€ä¸ªè„šæœ¬å®šæœŸä» Firebase Storage ä¸‹è½½æ–°æ–‡ä»¶ï¼š

```python
# download_from_firebase.py
import firebase_admin
from firebase_admin import credentials, storage

cred = credentials.Certificate('serviceAccountKey.json')
firebase_admin.initialize_app(cred, {
    'storageBucket': 'your-project-id.appspot.com'
})

bucket = storage.bucket()
blobs = bucket.list_blobs(prefix='game-logs/')

for blob in blobs:
    if not blob.metadata or not blob.metadata.get('processed'):
        # ä¸‹è½½å¹¶å¤„ç†
        blob.download_to_filename(f'local/{blob.name}')
```

## ğŸ’° æˆæœ¬

### å…è´¹é¢åº¦ï¼ˆå®Œå…¨å¤Ÿç”¨ï¼‰

**æ¯å¤© 50 ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼ˆå·²è®¾ç½®æ¯æ—¥é™é¢ï¼‰ï¼š**

- Storage: 50 Ã— 20 KB = 1 MB/å¤© â‰ˆ 30 MB/æœˆ âœ… (å…è´¹ 5 GB)
- Firestore: 50 Ã— 3 = 150 å†™å…¥/å¤©ï¼ˆæ–‡ä»¶ + è®¡æ•°å™¨ + æ—¥å¿—ï¼‰âœ… (å…è´¹ 20,000/å¤©)
- Functions: 50 Ã— 2 = 100 è°ƒç”¨/å¤© = 3,000/æœˆ âœ… (å…è´¹ 125,000/æœˆ)

**ç»“è®ºï¼šå®Œå…¨å…è´¹ï¼** ğŸ‰

### æ¯æ—¥é™é¢çš„å¥½å¤„

ç”±äºè®¾ç½®äº†æ¯å¤©æœ€å¤š 50 ä¸ªæ–‡ä»¶çš„é™é¢ï¼š

**æˆæœ¬å¯é¢„æµ‹ï¼š**
- æ¯æœˆæœ€å¤šï¼š50 Ã— 30 = 1,500 ä¸ªæ–‡ä»¶
- Storage: 1,500 Ã— 20 KB â‰ˆ 30 MB âœ…
- Firestore: 1,500 Ã— 3 = 4,500 å†™å…¥/æœˆ âœ…
- Functions: 1,500 Ã— 2 = 3,000 è°ƒç”¨/æœˆ âœ…

**å®Œå…¨åœ¨å…è´¹é¢åº¦å†…ï¼Œæ— éœ€æ‹…å¿ƒæ»¥ç”¨ï¼**

å»ºè®®ï¼šè®¾ç½®é¢„ç®—æé†’ $1/æœˆï¼Œå®é™…ä¸ä¼šäº§ç”Ÿè´¹ç”¨ã€‚

## ğŸ” æœ€ä½³å®è·µ

### 1. å®šæœŸæ£€æŸ¥ä¸Šä¼ 

æ¯å‘¨æŸ¥çœ‹ Firestore å’Œ Storageï¼Œç¡®è®¤æ²¡æœ‰å¼‚å¸¸ä¸Šä¼ ã€‚

### 2. å¤‡ä»½æ•°æ®

å®šæœŸå¯¼å‡º Firestore æ•°æ®ï¼š

```bash
gcloud firestore export gs://your-bucket/backups
```

### 3. ç›‘æ§æˆæœ¬

Firebase Console â†’ Usage and billing â†’ è®¾ç½®é¢„ç®—æé†’

### 4. æ›´æ–°è§„åˆ™

æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´ `storage.rules` å’Œ `firestore.rules`ã€‚

### 5. è®°å½•ä¸Šä¼ è€…

è™½ç„¶æ˜¯åŒ¿åä¸Šä¼ ï¼Œä½†ä¿ç•™æ˜µç§°å­—æ®µï¼Œæ–¹ä¾¿è¿½è¸ªã€‚

## ğŸ†š å¯¹æ¯”ï¼šæœ‰ç™»å½• vs æ— ç™»å½•

| ç‰¹æ€§ | æœ‰ç™»å½• | æ— ç™»å½• |
|-----|-------|-------|
| ç”¨æˆ·ä½“éªŒ | éœ€è¦Googleç™»å½• | ç›´æ¥ä¸Šä¼  |
| å®‰å…¨æ€§ | å¯è¿½è¸ªç”¨æˆ· | ä¾èµ–å…¶ä»–æªæ–½ |
| æ»¥ç”¨é£é™© | ä½ | ä¸­ç­‰ |
| éƒ¨ç½²å¤æ‚åº¦ | é«˜ | ä½ |
| é€‚ç”¨åœºæ™¯ | å°é—­ç¤¾ç¾¤ | å¼€æ”¾ç¤¾ç¾¤ |

## â“ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•çŸ¥é“æ˜¯è°ä¸Šä¼ çš„ï¼Ÿ**
A: é€šè¿‡å¯é€‰çš„æ˜µç§°å­—æ®µï¼Œæˆ–è€…åœ¨ Cloud Functions ä¸­è®°å½• IP åœ°å€ã€‚

**Q: å¦‚æœæœ‰äººæ¶æ„ä¸Šä¼ å¤§é‡æ–‡ä»¶æ€ä¹ˆåŠï¼Ÿ**
A: å·²è®¾ç½®æ¯æ—¥ 50 ä¸ªæ–‡ä»¶çš„é™åˆ¶ï¼Œå®Œå…¨åœ¨å…è´¹é¢åº¦å†…ã€‚å¦‚éœ€æ›´ä¸¥æ ¼é™åˆ¶ï¼Œå¯ä»¥é™ä½æ¯æ—¥é…é¢ã€‚

**Q: æ¯æ—¥é™é¢ä½•æ—¶é‡ç½®ï¼Ÿ**
A: æ¯å¤© UTC 00:00 è‡ªåŠ¨é‡ç½®ã€‚å¦‚æœéœ€è¦æŒ‰å½“åœ°æ—¶åŒºé‡ç½®ï¼Œéœ€è¦ä¿®æ”¹ `getTodayString()` å‡½æ•°ã€‚

**Q: å¯ä»¥ä¿®æ”¹æ¯æ—¥é™é¢å—ï¼Ÿ**
A: å¯ä»¥ã€‚åœ¨ `firestore.rules` å’Œ `functions/index.js` ä¸­ä¿®æ”¹æ•°å­— `50` å³å¯ã€‚

**Q: å¯ä»¥é™åˆ¶åªæœ‰ç‰¹å®šåŸŸåèƒ½ä¸Šä¼ å—ï¼Ÿ**
A: ä½¿ç”¨ Firebase App Check å¯ä»¥å®ç°è¿™ä¸€ç‚¹ã€‚

**Q: å¦‚ä½•åˆ é™¤æ¶æ„ä¸Šä¼ çš„æ–‡ä»¶ï¼Ÿ**
A: åœ¨ Firebase Console â†’ Storage ä¸­æ‰‹åŠ¨åˆ é™¤ï¼Œæˆ–é€šè¿‡ Admin SDK æ‰¹é‡åˆ é™¤ã€‚

**Q: æ— ç™»å½•æ˜¯å¦å®‰å…¨ï¼Ÿ**
A: å¯¹äºç¤¾ç¾¤é¡¹ç›®å®Œå…¨å®‰å…¨ã€‚æœ‰æ–‡ä»¶ç±»å‹ã€å¤§å°é™åˆ¶ï¼Œä¸”å¯ä»¥è¿½æº¯ã€‚å¦‚éœ€æ›´é«˜å®‰å…¨æ€§ï¼Œå»ºè®®æ·»åŠ  App Checkã€‚

## ğŸ“š å‚è€ƒèµ„æº

- [Firebase Storage Security Rules](https://firebase.google.com/docs/storage/security)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Firebase App Check](https://firebase.google.com/docs/app-check)
- [Cloud Functions æ–‡æ¡£](https://firebase.google.com/docs/functions)

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Firebase é¡¹ç›®å·²åˆ›å»º
- [ ] Firestore Database å·²å¯ç”¨
- [ ] Storage å·²å¯ç”¨
- [ ] Firebase é…ç½®å·²æ›´æ–°åˆ° upload.html
- [ ] .firebaserc å·²æ›´æ–°é¡¹ç›® ID
- [ ] Functions ä¾èµ–å·²å®‰è£…
- [ ] å·²ç™»å½• Firebase CLI
- [ ] Storage è§„åˆ™å·²éƒ¨ç½²
- [ ] Firestore è§„åˆ™å·²éƒ¨ç½²
- [ ] Cloud Functions å·²éƒ¨ç½²
- [ ] Hosting å·²éƒ¨ç½²
- [ ] ä¸Šä¼ åŠŸèƒ½å·²æµ‹è¯•
- [ ] æ–‡ä»¶æˆåŠŸå­˜å‚¨åˆ° Storage
- [ ] å…ƒæ•°æ®æˆåŠŸä¿å­˜åˆ° Firestore
- [ ] Functions æ—¥å¿—æ— é”™è¯¯

å®Œæˆåï¼Œä½ å°±æœ‰ä¸€ä¸ªå®Œå…¨å¼€æ”¾ã€æ— éœ€ç™»å½•çš„ä¸Šä¼ ç³»ç»Ÿäº†ï¼ğŸ‰
